<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <title>Memory</title>
    <link rel="stylesheet" type="text/css" href="CSS/formate.css" />
    <link rel="icon" type="image/x-icon"
        href="https://www.amadeus-hospitality.com/wp-content/uploads/2018/05/amadeus-icon-1.png">
    <script src="Skripte/Script1.js" type="text/javascript"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
</head>

<body>
    <header>
        <div>
            <a id="links" href="profile.html" title="Profil" style="margin-left: 10px;"> <img class="profile"
                    src="Bilder/profile.jpg"></a>
            <a id="links" href="leaderboard.html" title="Bestliste" style="margin-left: 10px;"> <img class="profile"
                    src="Bilder/trophy.jpg"></a>
            <a id="links" href="instructions.html" title="Anleitung" style="margin-left: 10px;"> <img class="info"
                    src="Bilder/info.png"></a>
        </div>
        <div><a id="rechts" class="link" href="https://www.bsz-fs.de/" title="Link zur Home-Page"> <img width="250"
                    src="Bilder/logo.png"></a></div>
        <div>
            <h1 class=center>JFKÂ´s Memory</h1>
        </div>
    </header>
    <h3 id="kostenlos" class="center" style="color: white;"> Jetzt kostenlos spielen<br></h3>
    <div id="wrapper" class="hide">
        <div class="stats-container">
            <div id="moves-count"></div>
            <div id="time"></div>
        </div>
        <div class="game-container"></div>
        <button id="stopbtn" class="" name="stopbtn">Aufgeben</button>
    </div>
    <div id="controlsContainer" class="controls-container">
        <p id="result"></p>
        <button id="start" name="start">Spiel starten</button>
        <button id="multiplayerbtn" name="start">Mehrspieler</button>
    </div>

    <div id="onlineContainer" class="online-container hide">
        <div id="backbtn-container"><button id="backbtn"><img id="online-back" src="Bilder/backbtn.png"></button></div>
        <h2 style="margin-left: 30%; margin-right: 30%; margin-bottom: 20px;">Mehrspieler</h2>
        <hr style="height: 5px; background-color: black; border-radius: 2px; border-color: black;">
        <div id="button-box" class="hide" style="margin-top: 30px;">
            <button id="lookGamebtn">Spiel suchen</button>
            <button id="createGamebtn" style="margin-bottom: 25px;">Spiel erstellen</button>
            <hr style="height: 5px; background-color: black; border-radius: 2px; border-color: black;">
            <button id="invitePlayerbtn" style="margin-top: 25px;">Spieler einladen</button>
            <button id="invitationbtn" style="margin-bottom: 25px;">Einladungen</button>
        </div>
        <table id="hosted-games" class="hide">
            <tr>
                <th colspan="5" style="padding: 10px;">Spiel suchen</th>
            </tr>
            <tr>
                <th>ID</th>
                <th>Spielname</th>
                <th>Spieler</th>
                <th>Sucht seit</th>
                <th>Aktion</th>
            </tr>
        </table>

        <div id="createGame-container" class="hide">
            <label id="gameNameLabel" for="nameLabel">Spielname</label>
            <input id="gameNameInput" type="text" name="nameLabel" placholder="Enter Email" required>
            <button id="newGamebtn">Spiel erstellen</button>
        </div>

        <div id="lookPlayer-container" class="hide">
            <label id="messageLabel" for="lookPlayerLabel">Nachricht</label>
            <input id="messageInput" type="text" name="lookPlayerLabel" placholder="Enter Email" required>
            <label id="lookPlayerLabel" for="lookPlayerLabel">Spieler</label>
            <input id="lookPlayerInput" type="text" name="lookPlayerLabel" placholder="Enter Email" required>
            <button id="lookPlayerbtn">Einladung seden</button>
            <button id="filterPlayerbtn">Alle Spieler filtern</button>
            <table id="all-players" class="">
                <tr>
                    <th colspan="4" style="padding: 10px;">Alle Spieler</th>
                </tr>
                <tr>
                    <th>ID</th>
                    <th>Spieler</th>
                    <th>Aktion</th>
                </tr>
            </table>
        </div>
        <table id="invitation-container" class="hide">
            <tr>
                <th colspan="5" style="padding: 10px;">Einladungen</th>
            </tr>
            <tr>
                <th>ID</th>
                <th>Message</th>
                <th>Spieler</th>
                <th>Empfangen</th>
                <th>Aktion</th>
            </tr>
        </table>

    </div>
    <!-- Script -->
    <script src="Skripte/Memory.js"></script>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-analytics.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getDatabase, ref, update, child, get, onValue } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyDgRC9CiBJRt2_gsHlRifB-MpE_xii7DXM",
            authDomain: "memory-app-b17ee.firebaseapp.com",
            projectId: "memory-app-b17ee",
            storageBucket: "memory-app-b17ee.appspot.com",
            messagingSenderId: "3637204477",
            appId: "1:3637204477:web:1493290d44957d81997594",
            measurementId: "G-XWPBGZWB4S",
            databaseURL: "https://memory-app-b17ee-default-rtdb.europe-west1.firebasedatabase.app"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const user = auth.currentUser;
        const database = getDatabase(app);
        const dbRef = ref(getDatabase(app));

        const kostenlos = document.getElementById("kostenlos");
        const controlsContainer = document.getElementById("controlsContainer");
        const wrapper = document.getElementById("wrapper");

        const onlineContainer = document.getElementById("onlineContainer");
        const buttonBox = document.getElementById("button-box");
        const hostedGames = document.getElementById("hosted-games");
        const createGame = document.getElementById("createGame-container");
        const invitePlayer = document.getElementById("lookPlayer-container");
        const invitations = document.getElementById("invitation-container");
        const allPlayers = document.getElementById("all-players");

        const multiplayerbtn = document.getElementById("multiplayerbtn");


        const footer = document.getElementById("gameFooter");

        var onlineGames = [];
        var all_user = [];
        var all_invitations = [];
        var myName = "";

        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in, see docs for a list of available properties
                // https://firebase.google.com/docs/reference/js/firebase.User
                const uid = user.uid;
                // ...
                let all_user = [];
                let myName = "";
                let all_invitations = [];
                let onlineGames = [];

                const dataToFetch = [
                    { path: `list_all_users`, target: all_user },
                    { path: `users/${uid}/username`, target: myName },
                    { path: `users/${uid}/invitations`, target: all_invitations },
                    { path: `memory/list_hosted_games`, target: onlineGames },
                ];

                dataToFetch.forEach(({ path, target }) => {
                    get(child(dbRef, path)).then((snapshot) => {
                        if (snapshot.exists()) {
                            console.log(snapshot.val());
                            target = snapshot.val();
                        } else {
                            console.log("No data available");
                        }
                    }).catch((error) => {
                        console.error(error);
                    });
                });

                var games = [];
                var new_game = {
                    start: "",
                    moves: "",
                    time: "",
                    end: "",
                    won: false
                };

                multiplayerbtn.classList.remove("hide");

                get(child(dbRef, `users/${user.uid}/offline_games`)).then((snapshot) => {
                    if (snapshot.exists()) {
                        console.log(snapshot.val());
                        //alert(snapshot.val())
                        games = snapshot.val();
                        //alert("games loaded");
                    } else {
                        console.log("No data available");
                    }
                }).catch((error) => {
                    //alert(error)
                    console.error(error);
                });

                document.addEventListener("myCustomEvent", e => {
                    const date = new Date();
                    const time = document.getElementById("time-won");
                    const moves = document.getElementById("moves-won");

                    new_game.moves = moves.innerHTML;
                    new_game.time = time.innerHTML;
                    new_game.end = date.toUTCString();
                    new_game.won = true;

                    games.push(new_game);

                    console.log(new_game);
                    update(ref(database, `users/${user.uid}`), {
                        offline_games: games
                    })
                        .then(() => {
                            // Data saved successfully!
                            //alert("secessfully saved data")
                            get(child(dbRef, `users/${user.uid}/offline_games`)).then((snapshot) => {
                                if (snapshot.exists()) {
                                    console.log(snapshot.val());
                                    //alert(snapshot.val())
                                    games = snapshot.val();
                                    //alert("games loaded");
                                    new_game = {
                                        start: "not started yet",
                                        moves: "",
                                        time: "",
                                        end: "",
                                        won: false
                                    };
                                } else {
                                    console.log("No data available");
                                }
                            }).catch((error) => {
                                //alert(error)
                                console.error(error);
                            });
                        })
                        .catch((error) => {
                            // The write failed...
                            document.getElementById("errorMessage").innerText = error
                            //alert(error)
                        });
                })

                start.addEventListener('click', (e) => {
                    const date = new Date();

                    new_game.start = date.toUTCString();

                    console.log(new_game);
                });


                stopbtn.addEventListener('click', (e) => {
                    const date = new Date();
                    const time = document.getElementById("time-content");
                    const moves = document.getElementById("moves-content");

                    new_game.moves = moves.innerHTML;
                    new_game.time = time.innerHTML;
                    new_game.end = date.toUTCString();
                    new_game.won = false;

                    games.push(new_game);

                    console.log(new_game);
                    update(ref(database, `users/${user.uid}`), {
                        offline_games: games
                    })
                        .then(() => {
                            // Data saved successfully!
                            // alert("secessfully saved data")
                            return get(child(dbRef, `users/${user.uid}/offline_games`));
                        })
                        .then((snapshot) => {
                            if (snapshot.exists()) {
                                console.log(snapshot.val());
                                // alert(snapshot.val())
                                games = snapshot.val();
                                // alert("games loaded");
                                new_game = {
                                    start: "not started yet",
                                    moves: "",
                                    time: "",
                                    end: "",
                                    won: false
                                };
                            } else {
                                console.log("No data available");
                            }
                        })
                        .catch((error) => {
                            // The write failed...
                            document.getElementById("errorMessage").innerText = error;
                            // alert(error)
                        });
                });


            } else {
                // User is signed out
                // ...
                multiplayerbtn.classList.add("hide");
            }
        });


        multiplayerbtn.addEventListener('click', (e) => {
            controlsContainer.classList.add("hide");
            wrapper.classList.add("hide");
            onlineContainer.classList.remove("hide");
            buttonBox.classList.remove("hide");
            kostenlos.classList.add("hide");
            footer.classList.replace("bottom", "endBottom");
        });

        start.addEventListener('click', (e) => {
            controlsContainer.classList.add("hide");
            wrapper.classList.remove("hide");
            footer.classList.add("hide");
        });

        stopbtn.addEventListener('click', (e) => {
            controlsContainer.classList.remove("hide");
            wrapper.classList.add("hide");
            footer.classList.remove("hide");
        });

        backbtn.addEventListener('click', (e) => {
            if (buttonBox.classList.contains("hide") == false) {
                onlineContainer.classList.add("hide");
                controlsContainer.classList.remove("hide");
                kostenlos.classList.remove("hide");
                footer.classList.replace("endBottom", "bottom");
            } else {
                createGame.classList.add("hide");
                hostedGames.classList.add("hide");
                invitePlayer.classList.add("hide");
                invitations.classList.add("hide");
                buttonBox.classList.remove("hide");
            }
        });

        lookGamebtn.addEventListener('click', (e) => {
            buttonBox.classList.add("hide");
            hostedGames.classList.remove("hide");
            loadHostedGames();
        });

        createGamebtn.addEventListener('click', (e) => {
            buttonBox.classList.add("hide");
            createGame.classList.remove("hide");
        });

        invitePlayerbtn.addEventListener('click', (e) => {
            buttonBox.classList.add("hide");
            invitePlayer.classList.remove("hide");
            loadAllPlayers();
        });

        invitationbtn.addEventListener('click', (e) => {
            buttonBox.classList.add("hide");
            invitations.classList.remove("hide");
            loadAllInvitations();
        });

        filterPlayerbtn.addEventListener('click', (e) => {
            loadFilteredPlayers();
        });


        newGamebtn.addEventListener('click', (e) => {
            const auth = getAuth(app);
            const user = auth.currentUser;
            const date = new Date();

            const message = document.getElementById("gameNameInput").value;
            var email = `${user.email}`
            var username = "";

            swal({
                title: "Achtung!",
                text: `Wollen Sie wirklich das Spiel ${message} erstellen?`,
                icon: "warning",
                buttons: true,
                dangerMode: true,
            })
                .then((willDelete) => {
                    if (willDelete) {
                        get(child(dbRef, `users/${user.uid}/username`)).then((snapshot) => {
                            if (snapshot.exists()) {
                                console.log(snapshot.val());
                                //alert(snapshot.val())
                                username = snapshot.val();
                                let new_game = {
                                    gameName: message,
                                    email: email,
                                    username: username,
                                    start: date.toUTCString(),
                                    done: false,
                                    ready1: false,
                                    readz2: false,
                                    opp_username: "[Kein Spieler]"
                                };

                                onlineGames.push(new_game);

                                console.log(new_game);
                                update(ref(database, `memory`), {
                                    list_hosted_games: onlineGames
                                })
                                    .then(() => {
                                        // Data saved successfully!
                                        //alert("secessfully saved data")
                                        localStorage.setItem("gameID", onlineGames.length - 1);
                                        window.location.href = "lobby.html";

                                    })
                                    .catch((error) => {
                                        // The write failed...
                                        alert(error);
                                        //alert(error)
                                    });
                            } else {
                                //alert("no data")
                                console.log("no user logged in");
                            }
                        }).catch((error) => {
                            //alert(error)
                            console.error(error);
                        });


                    } else {
                        //swal("abgebrochen",{icon: "error"});
                    }
                });




        });

        lookPlayerbtn.addEventListener('click', (e) => {
            const auth = getAuth(app);
            const user = auth.currentUser;
            const opponent = document.getElementById("lookPlayerInput").value;
            const message = document.getElementById("messageInput").value;
            const date = new Date();
            let myName = "";
            let oppName = "";
            let opp_uid = "";

            swal({
                title: "Achtung!",
                text: `Wollen Sie ${opponent} wirklich einladen?`,
                icon: "warning",
                buttons: true,
                dangerMode: true,
            })
                .then((willDelete) => {
                    if (willDelete) {

                        get(child(dbRef, `users/${user.uid}/username`))
                            .then((snapshot) => {
                                if (snapshot.exists()) {
                                    myName = snapshot.val();
                                    for (let i = 0; i < all_user.length; i++) {
                                        if (all_user[i].username === opponent) {
                                            opp_uid = all_user[i].uid;
                                            oppName = all_user[i].username;
                                            break;
                                        }
                                    }
                                    if (opp_uid) {
                                        const newInvitation = {
                                            message,
                                            email: user.email,
                                            username: myName,
                                            opp_username: `[${oppName}] eingeladen`,
                                            received: date.toUTCString(),
                                            done: false
                                        };
                                        get(child(dbRef, `users/${opp_uid}/invitations`))
                                            .then((snapshot) => {
                                                let invitations = [];
                                                if (snapshot.exists()) {
                                                    invitations = snapshot.val();
                                                }
                                                invitations.push(newInvitation);
                                                update(ref(database, `users/${opp_uid}`), { invitations })
                                                    .then(() => {
                                                        localStorage.setItem("gameID", "");
                                                        localStorage.setItem("invitationID", invitations.length - 1);
                                                        localStorage.setItem("opp_uid", opp_uid);
                                                        window.location.href = "lobby.html";
                                                    })
                                                    .catch((error) => {
                                                        console.error("error with invite:", error);
                                                    });
                                            })
                                            .catch((error) => {
                                                console.error(error);
                                            });
                                    } else {
                                        console.error("Spieler nicht gefunden!");
                                    }
                                } else {
                                    console.error("No user logged in");
                                }
                            })
                            .catch((error) => {
                                console.error(error);
                            });

                    } else {
                        //swal("abgebrochen",{icon: "error"});
                    }
                });


        });


        function loadHostedGames() {
            const hostedGamesRef = ref(database, `memory/list_hosted_games`);

            onValue(hostedGamesRef, handleSnapshot);

            get(child(dbRef, `memory/list_hosted_games`))
                .then(handleSnapshot)
                .catch((error) => {
                    console.error(error);
                });

            function handleSnapshot(snapshot) {
                if (!snapshot.exists()) {
                    console.log("No data available");
                    return;
                }
                console.log(snapshot.val());
                onlineGames = snapshot.val();
                hostedGames.innerHTML = "<tr><th>ID</th><th>Spielname</th><th>Spieler</th><th>Sucht seit</th><th>Action</th></tr>";
                for (let i = 0; i < onlineGames.length; i++) {
                    if (!onlineGames[i].done || (onlineGames[i].username === myName)) {
                        const insertGame = `<tr><td>${i + 1}</td><td>${onlineGames[i].gameName}</td><td>${onlineGames[i].username}</td><td>${onlineGames[i].start}</td><td><button id="beitreten${i + 1}" style="padding: 5px; background-color: rgb(9, 0, 90);color: white; border-radius: 5px; border-width: 0px;">beitreten</button></td></tr>`
                        hostedGames.innerHTML += insertGame;
                    }
                }
                setUpButtonsJoinHostedGames();
            }
        }


        function loadAllPlayers() {
            const allPlayerRef = ref(database, `list_all_users`);

            onValue(allPlayerRef, handleSnapshot);

            get(child(dbRef, `list_all_users`))
                .then(handleSnapshot)
                .catch((error) => {
                    console.error(error);
                });

            function handleSnapshot(snapshot) {
                if (!snapshot.exists()) {
                    console.log("No data available");
                    return;
                }
                console.log(snapshot.val());
                all_user = snapshot.val();
                allPlayers.innerHTML = `<tr><th colspan="3" style="padding: 10px;">Alle Spieler</th></tr>`
                allPlayers.innerHTML += "<tr><th>ID</th><th>Spieler</th><th>Action</th></tr>";
                for (let i = 0; i < all_user.length; i++) {
                    const insertGame = `<tr><td>${i + 1}</td><td>${all_user[i].username}</td><td><button id="einladen${i + 1}" style="padding: 5px; background-color: rgb(9, 0, 90);color: white; border-radius: 5px; border-width: 0px;">auswÃ¤hlen</button></td></tr>`
                    allPlayers.innerHTML += insertGame;
                }
                setUpButtonsAllPlayers();
            }
        }

        function loadFilteredPlayers() {
            get(child(dbRef, `list_all_users`)).then((snapshot) => {
                if (snapshot.exists()) {
                    console.log(snapshot.val());
                    const allUsers = snapshot.val();
                    let pattern = document.getElementById("lookPlayerInput").value.toLowerCase();
                    let filteredUsers = allUsers;

                    if (pattern !== "") {
                        filteredUsers = allUsers.filter(user => user.username.toLowerCase().includes(pattern));
                    }

                    allPlayers.innerHTML = createPlayersTable(filteredUsers, pattern);
                    setUpButtonsAllPlayers();
                } else {
                    console.log("No data available");
                }
            }).catch((error) => {
                console.error(error);
            });
        }

        function createPlayersTable(filteredUsers, pattern) {
            let tableHeader = `<tr><th colspan="3" style="padding: 10px;">`;
            if (pattern === "") {
                tableHeader += `Alle Spieler</th></tr>`;
            } else {
                tableHeader += `Spieler mit "${pattern}"</th></tr>`;
            }

            let tableBody = "<tr><th>ID</th><th>Spieler</th><th>Action</th></tr>";
            for (let i = 0; i < filteredUsers.length; i++) {
                const insertPlayer = `<tr><td>${i + 1}</td><td>${filteredUsers[i].username}</td><td><button id="einladen${i + 1}" style="padding: 5px; background-color: rgb(9, 0, 90);color: white; border-radius: 5px; border-width: 0px;">auswÃ¤hlen</button></td></tr>`
                tableBody += insertPlayer;
            }

            return tableHeader + tableBody;
        }


        function setUpButtonsAllPlayers() {
            const cells = document.querySelectorAll("#all-players td");
            for (let i = 0; i < cells.length; i++) {
                const cell = cells[i];
                cell.addEventListener("click", () => {
                    const input = document.getElementById("lookPlayerInput");
                    let username = null;

                    if (cell.innerHTML.includes("button")) {
                        let z = cell.innerHTML;
                        username = all_user[parseInt(z.substring(20, 21)) - 1].username;
                    } else if (isNumeric(cell.innerHTML)) {
                        username = all_user[parseInt(cell.innerHTML) - 1].username;
                    } else {
                        username = cell.innerHTML;
                    }
                    input.value = username;
                });
            }
        }


        async function setUpButtonsJoinHostedGames() {
            const cells = document.querySelectorAll("#hosted-games td");
            for (let i = 0; i < cells.length; i++) {
                cells[i].addEventListener("click", async function () {
                    const auth = await getAuth(app);
                    const user = auth.currentUser;
                    const list_hosted_games = await get(child(dbRef, `memory/list_hosted_games`));

                    if (list_hosted_games.exists()) {
                        let onlineGames = list_hosted_games.val();

                        if (this.innerHTML.includes("button")) {
                            let z = this.innerHTML;
                            z = parseInt(z.substring(21, 22));
                            let game = onlineGames[z - 1];

                            if (game.done && game.username !== myName) {
                                swal("Ups!", "Diese Lobby ist leider voll.", "error");
                            } else {
                                const shouldJoin = await swal({
                                    title: "Achtung!",
                                    text: `Wollen Sie ${game.username} "${game.gameName}" wirklich beitreten?`,
                                    icon: "warning",
                                    buttons: true,
                                    dangerMode: true,
                                });

                                if (shouldJoin) {
                                    const usernameSnapshot = await get(child(dbRef, `users/${user.uid}/username`));
                                    if (usernameSnapshot.exists()) {
                                        const username = usernameSnapshot.val();

                                        game.done = true;
                                        if (game.username !== username) {
                                            game["opp_username"] = username;
                                        }

                                        onlineGames[z - 1] = game;
                                        update(ref(database, `memory`), { list_hosted_games: onlineGames })
                                            .then(() => {
                                                localStorage.setItem("gameID", z - 1);
                                                localStorage.setItem("invitationID", "");
                                                window.location.href = "lobby.html"
                                            })
                                            .catch((error) => {
                                                console.error("Error joining game:", error);
                                            });
                                    } else {
                                        console.log("No user is logged in");
                                    }
                                }
                            }
                        } else {
                            for (let i = 0; i < onlineGames.length; i++) {
                                if (onlineGames[i].done && onlineGames[i].username !== myName) {
                                    swal("Ups!", "Diese Lobby ist leider voll.", "error");
                                } else if (
                                    i + 1 === parseInt(this.innerHTML) ||
                                    onlineGames[i].gameName === this.innerHTML ||
                                    onlineGames[i].start === this.innerHTML ||
                                    onlineGames[i].username === this.innerHTML
                                ) {
                                    const shouldJoin = await swal({
                                        title: "Achtung!",
                                        text: `Wollen Sie ${onlineGames[i].username} "${onlineGames[i].gameName}" wirklich beitreten?`,
                                        icon: "warning",
                                        buttons: true,
                                        dangerMode: true,
                                    });
                                    if (shouldJoin) {
                                        const usernameSnapshot = await get(child(dbRef, `users/${user.uid}/username`));
                                        if (usernameSnapshot.exists()) {
                                            const username = usernameSnapshot.val();

                                            onlineGames[i].done = true;
                                            if (onlineGames[i].username !== username) {
                                                onlineGames[i]["opp_username"] = username;
                                            }

                                            update(ref(database, `memory`), { list_hosted_games: onlineGames })
                                                .then(() => {
                                                    localStorage.setItem("gameID", i);
                                                    localStorage.setItem("invitationID", "");
                                                    window.location.href = "lobby.html";
                                                })
                                                .catch((error) => {
                                                    console.error("Error joining game:", error);
                                                });
                                        } else {
                                            console.log("No user is logged in");
                                        }
                                        break;
                                    }
                                }
                            }
                        }
                    } else {
                        console.log("No hosted games found");
                    }
                });
            }
        }


        function setUpButtonsJoinInvitations() {
            document.querySelectorAll("#invitation-container td").forEach(cell => {
                cell.addEventListener("click", () => {
                    const invitationIndex = getInvitationIndex(cell);

                    if (invitationIndex === -1) {
                        return;
                    }

                    showJoinConfirmation(invitationIndex);
                });
            });
        }

        function getInvitationIndex(cell) {
            if (cell.innerHTML.includes("button")) {
                return parseInt(cell.innerHTML.substring(20, 21)) - 1;
            }

            return all_invitations.findIndex(invitation => [invitation.received, invitation.message, invitation.username].includes(cell.innerHTML));
        }

        async function showJoinConfirmation(invitationIndex) {
            const { username, message } = all_invitations[invitationIndex];
            const confirmed = await swal({
                title: "Achtung!",
                text: `Wollen Sie ${username} "${message}" wirklich beitreten?`,
                icon: "warning",
                buttons: true,
                dangerMode: true
            });

            if (!confirmed) {
                return;
            }

            joinInvitation(invitationIndex);
        }

        async function joinInvitation(invitationIndex) {
            const auth = getAuth(app);
            const user = auth.currentUser;
            const myName = await get(child(dbRef, `users/${user.uid}/username`));

            if (!myName.exists()) {
                console.error("No user logged in");
                return;
            }

            all_invitations[invitationIndex].opp_username = myName.val();
            all_invitations[invitationIndex].done = true;

            try {
                await update(ref(database, `users/${user.uid}`), { invitations: all_invitations });
                localStorage.setItem("gameID", "");
                localStorage.setItem("invitationID", invitationIndex);
                localStorage.setItem("opp_uid", user.uid);
                window.location.href = "lobby.html";
            } catch (error) {
                alert("error with invite");
            }
        }



        function loadAllInvitations() {
            const auth = getAuth(app);
            const user = auth.currentUser;
            const invitationRef = ref(database, `users/${user.uid}/invitations`);

            onValue(invitationRef, handleSnapshot);

            get(child(dbRef, `users/${user.uid}/invitations`))
                .then(handleSnapshot)
                .catch((error) => {
                    console.error(error);
                });

            function handleSnapshot(snapshot) {
                if (!snapshot.exists()) {
                    console.log("No data available");
                    return;
                }
                console.log(snapshot.val());
                all_invitations = snapshot.val();
                invitations.innerHTML = `<tr><th colspan="5" style="padding: 10px;">Einladungen</th></tr><tr><th>ID</th><th>Message</th><th>Spieler</th><th>Empfangen</th><th>Aktion</th></tr>`
                for (let i = 0; i < all_invitations.length; i++) {
                    if (!all_invitations[i].done) {
                        const insertInvitation = `<tr><td>${i + 1}</td><td>${all_invitations[i].message}</td><td>${all_invitations[i].username}</td><td>${all_invitations[i].received}</td><td><button id="einladen${i + 1}" style="padding: 5px; background-color: rgb(9, 0, 90);color: white; border-radius: 5px; border-width: 0px;">beitreten</button></td></tr>`
                        invitations.innerHTML += insertInvitation;
                    }
                }
                setUpButtonsJoinInvitations();
            }

        }

        function isNumeric(str) {
            if (typeof str != "string") return false // we only process strings!  
            return !isNaN(str) && // use type coercion to parse the _entirety_ of the string (`parseFloat` alone does not do this)...
                !isNaN(parseFloat(str)) // ...and ensure strings of whitespace fail
        }

    </script>

    <footer id="gameFooter" class="bottom">
        <div style="margin-bottom: 8px; line-height: 15px;">
            Die Ravensburger AG ist in Deutschland im Besitz der eingetragenen Wortmarke "Memory". <br>
            Die Spielidee selbst geht zuzrÃ¼ck bis ins 12. Jahrhundert. <br />
        </div>
        <hr class="trenn-linie" style="margin-bottom: 5px;">
        </hr>
        <dev>
            Copyright 2022
            <a href="impressum.html" title="Impressum"> <img class="yin15" src="Bilder/yinyang.jpg"></a>
            IT-Abteilung der Berufsschule Freising. <br>
        </dev>
        <dev>
            <a href="index.html" title="Welcome">Welcome </a>
            |
            <a href="impressum.html" title="Impressum">Impressum</a>
        </dev>
    </footer>

</body>

</html>