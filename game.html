<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <title>Memory</title>
    <link rel="stylesheet" type="text/css" href="CSS/formate.css" />
    <link rel="icon" type="image/x-icon"
        href="https://www.amadeus-hospitality.com/wp-content/uploads/2018/05/amadeus-icon-1.png">
    <script src="Skripte/Script1.js" type="text/javascript"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
</head>

<body>
    <header>
        <div>
            <a id="links" href="profile.html" title="Profil" style="margin-left: 10px;"> <img class="profile"
                    src="Bilder/profile.jpg"></a>
            <a id="links" href="leaderboard.html" title="Bestliste" style="margin-left: 10px;"> <img class="profile"
                    src="Bilder/trophy.jpg"></a>
            <a id="links" href="instructions.html" title="Anleitung" style="margin-left: 10px;"> <img class="info"
                    src="Bilder/info.png"></a>
        </div>
        <div><a id="rechts" class="link" href="https://www.bsz-fs.de/" title="Link zur Home-Page"> <img width="250"
                    src="Bilder/logo.png"></a></div>
        <div>
            <h1 class=center>JFK´s Memory</h1>
        </div>
    </header>
    <h3 id="kostenlos" class="center" style="color: white;"> Jetzt kostenlos spielen<br></h3>
    <div id="wrapper" class="hide">
        <div class="stats-container">
            <div id="moves-count"></div>
            <div id="time"></div>
        </div>
        <div class="game-container"></div>
        <button id="stopbtn" class="" name="stopbtn">Aufgeben</button>
    </div>
    <div id="controlsContainer" class="controls-container">
        <p id="result"></p>
        <button id="start" name="start">Spiel starten</button>
        <button id="multiplayerbtn" name="start">Mehrspieler</button>
    </div>

    <div id="onlineContainer" class="online-container hide">
        <div id="backbtn-container"><button id="backbtn"><img id="online-back" src="Bilder/backbtn.png"></button></div>
        <h2 style="margin-left: 30%; margin-right: 30%; margin-bottom: 20px;">Mehrspieler</h2>
        <hr style="height: 5px; background-color: black; border-radius: 2px; border-color: black;">
        <div id="button-box" class="hide" style="margin-top: 30px;">
            <button id="lookGamebtn">Spiel suchen</button>
            <button id="createGamebtn" style="margin-bottom: 25px;">Spiel erstellen</button>
            <hr style="height: 5px; background-color: black; border-radius: 2px; border-color: black;">
            <button id="invitePlayerbtn" style="margin-top: 25px;">Spieler einladen</button>
            <button id="invitationbtn" style="margin-bottom: 25px;">Einladungen</button>
        </div>
        <table id="hosted-games" class="hide">
            <tr>
                <th colspan="5" style="padding: 10px;">Spiel suchen</th>
            </tr>
            <tr>
                <th>ID</th>
                <th>Spielname</th>
                <th>Spieler</th>
                <th>Sucht seit</th>
                <th>Aktion</th>
            </tr>
        </table>

        <div id="createGame-container" class="hide">
            <label id="gameNameLabel" for="nameLabel">Spielname</label>
            <input id="gameNameInput" type="text" name="nameLabel" placholder="Enter Email" required>
            <button id="newGamebtn">Spiel erstellen</button>
        </div>

        <div id="lookPlayer-container" class="hide">
            <label id="messageLabel" for="lookPlayerLabel">Nachricht</label>
            <input id="messageInput" type="text" name="lookPlayerLabel" placholder="Enter Email" required>
            <label id="lookPlayerLabel" for="lookPlayerLabel">Spieler</label>
            <input id="lookPlayerInput" type="text" name="lookPlayerLabel" placholder="Enter Email" required>
            <button id="lookPlayerbtn">Einladung seden</button>
            <button id="filterPlayerbtn">Alle Spieler filtern</button>
            <table id="all-players" class="">
                <tr>
                    <th colspan="4" style="padding: 10px;">Alle Spieler</th>
                </tr>
                <tr>
                    <th>ID</th>
                    <th>Spieler</th>
                    <th>Aktion</th>
                </tr>
            </table>
        </div>
        <table id="invitation-container" class="hide">
            <tr>
                <th colspan="5" style="padding: 10px;">Einladungen</th>
            </tr>
            <tr>
                <th>ID</th>
                <th>Message</th>
                <th>Spieler</th>
                <th>Empfangen</th>
                <th>Aktion</th>
            </tr>
        </table>

    </div>
    <!-- Script -->
    <script src="Skripte/Memory.js"></script>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-analytics.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getDatabase, ref, update, child, get } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyDgRC9CiBJRt2_gsHlRifB-MpE_xii7DXM",
            authDomain: "memory-app-b17ee.firebaseapp.com",
            projectId: "memory-app-b17ee",
            storageBucket: "memory-app-b17ee.appspot.com",
            messagingSenderId: "3637204477",
            appId: "1:3637204477:web:1493290d44957d81997594",
            measurementId: "G-XWPBGZWB4S",
            databaseURL: "https://memory-app-b17ee-default-rtdb.europe-west1.firebasedatabase.app"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const user = auth.currentUser;
        const database = getDatabase(app);
        const dbRef = ref(getDatabase(app));

        const kostenlos = document.getElementById("kostenlos");
        const controlsContainer = document.getElementById("controlsContainer");
        const wrapper = document.getElementById("wrapper");

        const onlineContainer = document.getElementById("onlineContainer");
        const buttonBox = document.getElementById("button-box");
        const hostedGames = document.getElementById("hosted-games");
        const createGame = document.getElementById("createGame-container");
        const invitePlayer = document.getElementById("lookPlayer-container");
        const invitations = document.getElementById("invitation-container");
        const allPlayers = document.getElementById("all-players");

        const multiplayerbtn = document.getElementById("multiplayerbtn");


        const footer = document.getElementById("gameFooter");

        var onlineGames = [];
        var all_user = [];
        var all_invitations = [];
        var myName = "";

        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in, see docs for a list of available properties
                // https://firebase.google.com/docs/reference/js/firebase.User
                const uid = user.uid;
                // ...
                all_user = [];
                get(child(dbRef, `list_all_users`)).then((snapshot) => {
                    if (snapshot.exists()) {
                        console.log(snapshot.val());
                        //alert(snapshot.val())
                        all_user = snapshot.val();
                    } else {
                        console.log("No data available");
                    }
                }).catch((error) => {
                    //alert(error)
                    console.error(error);
                });

                get(child(dbRef, `users/${uid}/username`)).then((snapshot) => {
                    if (snapshot.exists()) {
                        console.log(snapshot.val());
                        //alert(snapshot.val())
                        myName = snapshot.val();
                        //noUser.classList.add("hide");
                        //alert("games loaded");
                    } else {
                        //alert("no data");
                        console.log("No data available");
                    }
                }).catch((error) => {
                    //alert(error)
                    console.error(error);
                });

                all_invitations = [];
                get(child(dbRef, `users/${uid}/invitations`)).then((snapshot) => {
                    if (snapshot.exists()) {
                        console.log(snapshot.val());
                        //alert(snapshot.val())
                        all_invitations = snapshot.val();
                        //noUser.classList.add("hide");
                        //alert("games loaded");
                    } else {
                        //alert("no data");
                        console.log("No data available");
                    }
                }).catch((error) => {
                    //alert(error)
                    console.error(error);
                });

                onlineGames = [];
                get(child(dbRef, `memory/list_hosted_games`)).then((snapshot) => {
                    if (snapshot.exists()) {
                        console.log(snapshot.val());
                        //alert(snapshot.val())
                        onlineGames = snapshot.val();
                        //noUser.classList.add("hide");
                        //alert("games loaded");
                    } else {
                        //alert("no data");
                        console.log("No data available");
                    }
                }).catch((error) => {
                    //alert(error)
                    console.error(error);
                });

                var games = [];
                var new_game = {
                    start: "",
                    moves: "",
                    time: "",
                    end: "",
                    won: false
                };

                multiplayerbtn.classList.remove("hide");

                get(child(dbRef, `users/${user.uid}/offline_games`)).then((snapshot) => {
                    if (snapshot.exists()) {
                        console.log(snapshot.val());
                        //alert(snapshot.val())
                        games = snapshot.val();
                        //alert("games loaded");
                    } else {
                        console.log("No data available");
                    }
                }).catch((error) => {
                    //alert(error)
                    console.error(error);
                });

                document.addEventListener("myCustomEvent", e => {
                    const date = new Date();
                    const time = document.getElementById("time-won");
                    const moves = document.getElementById("moves-won");

                    new_game.moves = moves.innerHTML;
                    new_game.time = time.innerHTML;
                    new_game.end = date.toUTCString();
                    new_game.won = true;

                    games.push(new_game);

                    console.log(new_game);
                    update(ref(database, `users/${user.uid}`), {
                        offline_games: games
                    })
                        .then(() => {
                            // Data saved successfully!
                            //alert("secessfully saved data")
                            get(child(dbRef, `users/${user.uid}/offline_games`)).then((snapshot) => {
                                if (snapshot.exists()) {
                                    console.log(snapshot.val());
                                    //alert(snapshot.val())
                                    games = snapshot.val();
                                    //alert("games loaded");
                                    new_game = {
                                        start: "not started yet",
                                        moves: "",
                                        time: "",
                                        end: "",
                                        won: false
                                    };
                                } else {
                                    console.log("No data available");
                                }
                            }).catch((error) => {
                                //alert(error)
                                console.error(error);
                            });
                        })
                        .catch((error) => {
                            // The write failed...
                            document.getElementById("errorMessage").innerText = error
                            //alert(error)
                        });
                })

                start.addEventListener('click', (e) => {
                    const date = new Date();

                    new_game.start = date.toUTCString();

                    console.log(new_game);
                });


                stopbtn.addEventListener('click', (e) => {
                    const date = new Date();
                    const time = document.getElementById("time-content");
                    const moves = document.getElementById("moves-content");

                    new_game.moves = moves.innerHTML;
                    new_game.time = time.innerHTML;
                    new_game.end = date.toUTCString();
                    new_game.won = false;

                    games.push(new_game);

                    console.log(new_game);
                    update(ref(database, `users/${user.uid}`), {
                        offline_games: games
                    })
                        .then(() => {
                            // Data saved successfully!
                            //alert("secessfully saved data")
                            get(child(dbRef, `users/${user.uid}/offline_games`)).then((snapshot) => {
                                if (snapshot.exists()) {
                                    console.log(snapshot.val());
                                    //alert(snapshot.val())
                                    games = snapshot.val();
                                    //alert("games loaded");
                                    new_game = {
                                        start: "not started yet",
                                        moves: "",
                                        time: "",
                                        end: "",
                                        won: false
                                    };
                                } else {
                                    console.log("No data available");
                                }
                            }).catch((error) => {
                                //alert(error)
                                console.error(error);
                            });
                        })
                        .catch((error) => {
                            // The write failed...
                            document.getElementById("errorMessage").innerText = error
                            //alert(error)
                        });
                });

            } else {
                // User is signed out
                // ...
                multiplayerbtn.classList.add("hide");
            }
        });


        multiplayerbtn.addEventListener('click', (e) => {
            controlsContainer.classList.add("hide");
            wrapper.classList.add("hide");
            onlineContainer.classList.remove("hide");
            buttonBox.classList.remove("hide");
            kostenlos.classList.add("hide");
            footer.classList.replace("bottom", "endBottom");
        });

        start.addEventListener('click', (e) => {
            controlsContainer.classList.add("hide");
            wrapper.classList.remove("hide");
            footer.classList.add("hide");
        });

        stopbtn.addEventListener('click', (e) => {
            controlsContainer.classList.remove("hide");
            wrapper.classList.add("hide");
            footer.classList.remove("hide");
        });

        backbtn.addEventListener('click', (e) => {
            if (buttonBox.classList.contains("hide") == false) {
                onlineContainer.classList.add("hide");
                controlsContainer.classList.remove("hide");
                kostenlos.classList.remove("hide");
                footer.classList.replace("endBottom", "bottom");
            } else {
                createGame.classList.add("hide");
                hostedGames.classList.add("hide");
                invitePlayer.classList.add("hide");
                invitations.classList.add("hide");
                buttonBox.classList.remove("hide");
            }
        });

        lookGamebtn.addEventListener('click', (e) => {
            buttonBox.classList.add("hide");
            hostedGames.classList.remove("hide");
            loadHostedGames();
        });

        createGamebtn.addEventListener('click', (e) => {
            buttonBox.classList.add("hide");
            createGame.classList.remove("hide");
        });

        invitePlayerbtn.addEventListener('click', (e) => {
            buttonBox.classList.add("hide");
            invitePlayer.classList.remove("hide");
            loadAllPlayers();
        });

        invitationbtn.addEventListener('click', (e) => {
            buttonBox.classList.add("hide");
            invitations.classList.remove("hide");
            loadAllInvitations();
        });

        filterPlayerbtn.addEventListener('click', (e) => {
            loadFilteredPlayers();
        });


        newGamebtn.addEventListener('click', (e) => {
            const auth = getAuth(app);
            const user = auth.currentUser;
            const date = new Date();

            const message = document.getElementById("gameNameInput").value;
            var email = `${user.email}`
            var username = "";

            swal({
                title: "Achtung!",
                text: `Wollen Sie wirklich das Spiel ${message} erstellen?`,
                icon: "warning",
                buttons: true,
                dangerMode: true,
            })
                .then((willDelete) => {
                    if (willDelete) {
                        get(child(dbRef, `users/${user.uid}/username`)).then((snapshot) => {
                            if (snapshot.exists()) {
                                console.log(snapshot.val());
                                //alert(snapshot.val())
                                username = snapshot.val();
                                let new_game = {
                                    gameName: message,
                                    email: email,
                                    username: username,
                                    start: date.toUTCString(),
                                    done: false,
                                    ready1: false,
                                    readz2: false,
                                    opp_username: "[Kein Spieler]"
                                };

                                onlineGames.push(new_game);

                                console.log(new_game);
                                update(ref(database, `memory`), {
                                    list_hosted_games: onlineGames
                                })
                                    .then(() => {
                                        // Data saved successfully!
                                        //alert("secessfully saved data")
                                        localStorage.setItem("gameID", onlineGames.length - 1);
                                        window.location.href = "lobby.html";

                                    })
                                    .catch((error) => {
                                        // The write failed...
                                        alert(error);
                                        //alert(error)
                                    });
                            } else {
                                //alert("no data")
                                console.log("no user logged in");
                            }
                        }).catch((error) => {
                            //alert(error)
                            console.error(error);
                        });


                    } else {
                        //swal("abgebrochen",{icon: "error"});
                    }
                });




        });

        lookPlayerbtn.addEventListener('click', (e) => {
            const auth = getAuth(app);
            const user = auth.currentUser;
            const date = new Date();

            const opponent = document.getElementById("lookPlayerInput").value;
            const message = document.getElementById("messageInput").value;
            var email = `${user.email}`
            var myName = "";
            get(child(dbRef, `users/${user.uid}/username`)).then((snapshot) => {
                    if (snapshot.exists()) {
                        console.log(snapshot.val());
                        //alert(snapshot.val())
                        myName = snapshot.val()
                    } else {
                        //alert("no data")
                        console.log("No data available");
                    }
                }).catch((error) => {
                    //alert(error)
                    console.error(error);
                });

            var username = "";

            swal({
                title: "Achtung!",
                text: `Wollen Sie ${opponent} wirklich einladen?`,
                icon: "warning",
                buttons: true,
                dangerMode: true,
            })
                .then((willDelete) => {
                    if (willDelete) {
                        get(child(dbRef, `users/${user.uid}/username`)).then((snapshot) => {
                            if (snapshot.exists()) {
                                console.log(snapshot.val());
                                //alert(snapshot.val())
                                username = snapshot.val();

                                var oppName = "";
                                var opp_uid = "";
                                for (let i = 0; i < all_user.length; i++) {
                                    if (all_user[i].username === opponent) {
                                        opp_uid = all_user[i].uid;
                                        oppName = all_user[i].username;
                                    }
                                }

                                let new_invitation = {
                                    message: message,
                                    email: email,
                                    username: username,
                                    opp_username: `[${oppName}] eingeladen`,
                                    received: date.toUTCString(),
                                    done: false
                                };


                                if (!(opp_uid === "")) {
                                    get(child(dbRef, `users/${opp_uid}/invitations`)).then((snapshot) => {
                                        if (snapshot.exists()) {
                                            console.log(snapshot.val());
                                            //alert(snapshot.val())
                                            var invitations = snapshot.val();
                                            //noUser.classList.add("hide");
                                            //alert("games loaded");
                                            invitations.push(new_invitation);
                                            update(ref(database, `users/${opp_uid}`), {
                                                invitations
                                            })
                                                .then(() => {
                                                    // Data saved successfully!
                                                    localStorage.setItem("gameID", "");
                                                    localStorage.setItem("invitationID", invitations.length - 1);
                                                    localStorage.setItem("opp_uid", opp_uid);
                                                    window.location.href = "lobby.html";
                                                })
                                                .catch((error) => {
                                                    alert("error with invite");
                                                });
                                        } else {
                                            //alert("no data");
                                            console.log("No data available. Writing data...");
                                            var invitations = [];
                                            //noUser.classList.add("hide");
                                            //alert("games loaded");
                                            invitations.push(new_invitation);
                                            update(ref(database, `users/${opp_uid}`), {
                                                invitations
                                            })
                                            localStorage.setItem("gameID", "");
                                            localStorage.setItem("invitationID", invitations.length - 1);
                                            localStorage.setItem("opp_uid", opp_uid);
                                            window.location.href = "lobby.html";
                                        }
                                    }).catch((error) => {
                                        //alert(error)
                                        console.error(error);
                                    })
                                } else {

                                    alert("Spieler nicht gefunden!");
                                }
                            } else {
                                //alert("no data")
                                console.log("no user logged in");
                            }
                        }).catch((error) => {
                            //alert(error)
                            console.error(error);
                        });
                    } else {
                        //swal("abgebrochen",{icon: "error"});
                    }
                });





        });

        function loadHostedGames() {
            get(child(dbRef, `memory/list_hosted_games`)).then((snapshot) => {
                if (snapshot.exists()) {
                    console.log(snapshot.val());
                    //alert(snapshot.val())
                    onlineGames = snapshot.val();
                    //noUser.classList.add("hide");
                    //alert("games loaded");
                    hostedGames.innerHTML = "<tr><th>ID</th><th>Spielname</th><th>Spieler</th><th>Sucht seit</th><th>Action</th></tr>";
                    for (let i = 0; i < onlineGames.length; i++) {
                        if (!onlineGames[i].done || (onlineGames[i].username === myName)) {
                            const insertGame = `<tr><td>${i + 1}</td><td>${onlineGames[i].gameName}</td><td>${onlineGames[i].username}</td><td>${onlineGames[i].start}</td><td><button id="beitreten${i + 1}" style="padding: 5px; background-color: rgb(9, 0, 90);color: white; border-radius: 5px; border-width: 0px;">beitreten</button></td></tr>`
                            hostedGames.innerHTML += insertGame;
                        }
                    }
                    setUpButtonsJoinHostedGames();
                } else {
                    //alert("no data");
                    console.log("No data available");
                }
            }).catch((error) => {
                //alert(error)
                console.error(error);
            });

        }

        function loadAllPlayers() {
            get(child(dbRef, `list_all_users`)).then((snapshot) => {
                if (snapshot.exists()) {
                    console.log(snapshot.val());
                    //alert(snapshot.val())
                    all_user = snapshot.val();
                    //noUser.classList.add("hide");
                    //alert("games loaded");
                    allPlayers.innerHTML = `<tr><th colspan="3" style="padding: 10px;">Alle Spieler</th></tr>`
                    allPlayers.innerHTML += "<tr><th>ID</th><th>Spieler</th><th>Action</th></tr>";
                    for (let i = 0; i < all_user.length; i++) {
                        const insertGame = `<tr><td>${i + 1}</td><td>${all_user[i].username}</td><td><button id="einladen${i + 1}" style="padding: 5px; background-color: rgb(9, 0, 90);color: white; border-radius: 5px; border-width: 0px;">auswählen</button></td></tr>`
                        allPlayers.innerHTML += insertGame;
                    }
                    setUpButtonsAllPlayers();
                } else {
                    //alert("no data");
                    console.log("No data available");
                }
            }).catch((error) => {
                //alert(error)
                console.error(error);
            });

        }

        function loadFilteredPlayers() {
            get(child(dbRef, `list_all_users`)).then((snapshot) => {
                if (snapshot.exists()) {
                    console.log(snapshot.val());
                    //alert(snapshot.val())
                    all_user = snapshot.val();
                    //noUser.classList.add("hide");
                    //alert("games loaded");
                    var pattern = document.getElementById("lookPlayerInput").value;
                    if (pattern === "") {
                        allPlayers.innerHTML = `<tr><th colspan="3" style="padding: 10px;">Alle Spieler</th></tr>`
                        allPlayers.innerHTML += "<tr><th>ID</th><th>Spieler</th><th>Action</th></tr>";
                        for (let i = 0; i < all_user.length; i++) {
                            const insertPlayer = `<tr><td>${i + 1}</td><td>${all_user[i].username}</td><td><button id="einladen${i + 1}" style="padding: 5px; background-color: rgb(9, 0, 90);color: white; border-radius: 5px; border-width: 0px;">auswählen</button></td></tr>`
                            allPlayers.innerHTML += insertPlayer;
                        }
                    } else {
                        var result_users = [];
                        for (let i = 0; i < all_user.length; i++) {
                            if (all_user[i].username.toLowerCase().includes(pattern.toLowerCase())) {
                                result_users.push(all_user[i]);
                            }
                        }
                        allPlayers.innerHTML = `<tr><th colspan="3" style="padding: 10px;">Spieler mit "${pattern}"</th></tr>`
                        allPlayers.innerHTML += "<tr><th>ID</th><th>Spieler</th><th>Action</th></tr>";
                        for (let i = 0; i < result_users.length; i++) {
                            const insertPlayer = `<tr><td>${i + 1}</td><td>${result_users[i].username}</td><td><button id="einladen${i + 1}" style="padding: 5px; background-color: rgb(9, 0, 90);color: white; border-radius: 5px; border-width: 0px;">auswählen</button></td></tr>`
                            allPlayers.innerHTML += insertPlayer;
                        }
                    }
                    setUpButtonsAllPlayers()
                } else {
                    //alert("no data");
                    console.log("No data available");
                }
            }).catch((error) => {
                //alert(error)
                console.error(error);
            });

        }

        function setUpButtonsAllPlayers() {
            var cells = document.querySelectorAll("#all-players td");
            for (var i = 0; i < cells.length; i++) {
                cells[i].addEventListener("click", function () {
                    if (this.innerHTML.includes("button")) {
                        var num = -1;
                        var z = this.innerHTML;
                        z = z.substring(20, 21);
                        document.getElementById("lookPlayerInput").value = all_user[z - 1].username;
                    } else {
                        if (isNumeric(this.innerHTML)) {
                            document.getElementById("lookPlayerInput").value = all_user[parseInt(this.innerHTML) - 1].username;
                        } else {
                            document.getElementById("lookPlayerInput").value = this.innerHTML;
                        }
                    }

                });
            }
        }

        function setUpButtonsJoinHostedGames() {
            var cells = document.querySelectorAll("#hosted-games td");
            for (var i = 0; i < cells.length; i++) {
                cells[i].addEventListener("click", function () {
                    var auth = getAuth(app);
                    var user = auth.currentUser;
                    onlineGames = [];
                    get(child(dbRef, `memory/list_hosted_games`)).then((snapshot) => {
                        if (snapshot.exists()) {
                            console.log(snapshot.val());
                            //alert(snapshot.val())
                            onlineGames = snapshot.val();
                            //noUser.classList.add("hide");
                            if (this.innerHTML.includes("button")) {
                                var num = -1;
                                var z = this.innerHTML;
                                z = parseInt(z.substring(21, 22));
                                if (onlineGames[z - 1].done && !(onlineGames[z - 1].username === myName)) {
                                    swal("Ups!", "Diese Lobby ist leider voll.", "error");
                                } else {
                                    //alert(`Do you want to join Game: ${onlineGames[z-1].email}`);
                                    swal({
                                        title: "Achtung!",
                                        text: `Wollen Sie ${onlineGames[z - 1].username} "${onlineGames[z - 1].gameName}" wirklich beitreten?`,
                                        icon: "warning",
                                        buttons: true,
                                        dangerMode: true,
                                    })
                                        .then((willDelete) => {
                                            if (willDelete) {

                                                get(child(dbRef, `users/${user.uid}/username`)).then((snapshot) => {
                                                    if (snapshot.exists()) {
                                                        console.log(snapshot.val());
                                                        //alert(snapshot.val())
                                                        var username = snapshot.val();
                                                        onlineGames[z - 1].done = true;
                                                        if (!(onlineGames[z - 1].username === username)) {
                                                            onlineGames[z - 1]["opp_username"] = username;
                                                        }
                                                        var list_hosted_games = onlineGames;
                                                        update(ref(database, `memory`), {
                                                            list_hosted_games
                                                        })
                                                            .then(() => {
                                                                // Data saved successfully!
                                                                localStorage.setItem("gameID", z - 1);
                                                                localStorage.setItem("invitationID", "");
                                                                window.location.href = "lobby.html"
                                                            })
                                                            .catch((error) => {
                                                                alert("error with invite");
                                                            });
                                                    } else {
                                                        //alert("no data")
                                                        console.log("no user logged in");
                                                    }
                                                }).catch((error) => {
                                                    //alert(error)
                                                    console.error(error);
                                                });

                                            } else {
                                                //swal("abgebrochen",{icon: "error"});
                                            }
                                        });
                                }

                                //var x = confirm(`Wollen Sie ${onlineGames[z - 1].email} wirklich beitreten?`);
                            } else {
                                for (let i = 0; i < onlineGames.length; i++) {
                                    if (onlineGames[i].done && !(onlineGames[i].username === myName)) {
                                        swal("Ups!", "Diese Lobby ist leider voll.", "error");
                                    } else {
                                        if (i + 1 === parseInt(this.innerHTML) || onlineGames[i].gameName === this.innerHTML || onlineGames[i].start === this.innerHTML || onlineGames[i].username === this.innerHTML) {
                                            //alert(`Do you want to join Game: ${onlineGames[i].email}`);
                                            swal({
                                                title: "Achtung!",
                                                text: `Wollen Sie ${onlineGames[i].username} "${onlineGames[i].gameName}" wirklich beitreten?`,
                                                icon: "warning",
                                                buttons: true,
                                                dangerMode: true,
                                            })
                                                .then((willDelete) => {
                                                    if (willDelete) {
                                                        get(child(dbRef, `users/${user.uid}/username`)).then((snapshot) => {
                                                            if (snapshot.exists()) {
                                                                console.log(snapshot.val());
                                                                //alert(snapshot.val())
                                                                var username = snapshot.val();
                                                                onlineGames[i].done = true;
                                                                if (!(onlineGames[i].username === username)) {
                                                                    onlineGames[i]["opp_username"] = username;
                                                                    onlineGames[i]["ready1"] = false;
                                                                    onlineGames[i]["ready2"] = false;
                                                                }
                                                                var list_hosted_games = onlineGames;
                                                                update(ref(database, `memory`), {
                                                                    list_hosted_games
                                                                })
                                                                    .then(() => {
                                                                        // Data saved successfully!
                                                                        localStorage.setItem("gameID", i);
                                                                        localStorage.setItem("invitationID", "");
                                                                        window.location.href = "lobby.html"
                                                                    })
                                                                    .catch((error) => {
                                                                        alert("error with invite");
                                                                    });
                                                            } else {
                                                                //alert("no data")
                                                                console.log("no user logged in");
                                                            }
                                                        }).catch((error) => {
                                                            //alert(error)
                                                            console.error(error);
                                                        });



                                                    } else {
                                                        //swal("abgebrochen",{icon: "error"});
                                                    }
                                                });


                                        }
                                    }

                                }
                            }
                        } else {
                            //alert("no data");
                            console.log("No data available");
                        }
                    }).catch((error) => {
                        //alert(error)
                        console.error(error);
                    });

                });
            }
        }

        function setUpButtonsJoinInvitations() {
            var cells = document.querySelectorAll("#invitation-container td");
            for (var i = 0; i < cells.length; i++) {
                cells[i].addEventListener("click", function () {
                    if (this.innerHTML.includes("button")) {
                        var num = -1;
                        var z = this.innerHTML;
                        z = parseInt(z.substring(20, 21));
                        //alert(`Do you want to join Game: ${all_invitations[z-1].username}`);
                        swal({
                            title: "Achtung!",
                            text: `Wollen Sie ${all_invitations[z - 1].username} "${all_invitations[z - 1].message}" wirklich beitreten?`,
                            icon: "warning",
                            buttons: true,
                            dangerMode: true,
                        })
                            .then((willDelete) => {
                                if (willDelete) {
                                    const auth = getAuth(app);
                                    const user = auth.currentUser;
                                    //window.location.href = "lobby.html";
                                    all_invitations[z - 1].done = true;
                                    all_invitations[z - 1].opp_username = myName;
                                    var invitations = all_invitations;
                                    update(ref(database, `users/${user.uid}`), {
                                        invitations
                                    })
                                        .then(() => {
                                            // Data saved successfully!
                                            localStorage.setItem("gameID", "");
                                            localStorage.setItem("invitationID", z - 1);
                                            localStorage.setItem("opp_uid", user.uid);
                                            window.location.href = "lobby.html";
                                        })
                                        .catch((error) => {
                                            alert("error with invite");
                                        });
                                } else {
                                    //swal("abgebrochen",{icon: "error"});
                                }
                            });
                    } else {
                        for (let i = 0; i < all_invitations.length; i++) {
                            if (i + 1 === parseInt(this.innerHTML) || all_invitations[i].message === this.innerHTML || all_invitations[i].received === this.innerHTML || all_invitations[i].username === this.innerHTML) {
                                //alert(`Do you want to join Game: ${all_invitations[i].username}`);
                                swal({
                                    title: "Achtung!",
                                    text: `Wollen Sie ${all_invitations[i].username} "${all_invitations[i].message}" wirklich beitreten?`,
                                    icon: "warning",
                                    buttons: true,
                                    dangerMode: true,
                                })
                                    .then((willDelete) => {
                                        if (willDelete) {
                                            const auth = getAuth(app);
                                            const user = auth.currentUser;
                                            all_invitations[i].opp_username = myName;
                                            all_invitations[i].done = true;
                                            var invitations = all_invitations;
                                            update(ref(database, `users/${user.uid}`), {
                                                invitations
                                            })
                                                .then(() => {
                                                    // Data saved successfully!
                                                    localStorage.setItem("gameID", "");
                                                    localStorage.setItem("invitationID", i);
                                                    localStorage.setItem("opp_uid", user.uid);
                                                    window.location.href = "lobby.html";
                                                })
                                                .catch((error) => {
                                                    alert("error with invite");
                                                });
                                        } else {
                                            //swal("abgebrochen",{icon: "error"});
                                        }
                                    });
                            }
                        }
                    }
                });
            }
        }

        function loadAllInvitations() {
            const auth = getAuth(app);
            const user = auth.currentUser;
            get(child(dbRef, `users/${user.uid}/invitations`)).then((snapshot) => {
                if (snapshot.exists()) {
                    console.log(snapshot.val());
                    //alert(snapshot.val())
                    all_invitations = snapshot.val();
                    //noUser.classList.add("hide");
                    //alert("games loaded");
                    invitations.innerHTML = `<tr><th colspan="5" style="padding: 10px;">Einladungen</th></tr><tr><th>ID</th><th>Message</th><th>Spieler</th><th>Empfangen</th><th>Aktion</th></tr>`
                    for (let i = 0; i < all_invitations.length; i++) {
                        if (!all_invitations[i].done) {
                            const insertInvitation = `<tr><td>${i + 1}</td><td>${all_invitations[i].message}</td><td>${all_invitations[i].username}</td><td>${all_invitations[i].received}</td><td><button id="einladen${i + 1}" style="padding: 5px; background-color: rgb(9, 0, 90);color: white; border-radius: 5px; border-width: 0px;">beitreten</button></td></tr>`
                            invitations.innerHTML += insertInvitation;
                        }
                    }
                    setUpButtonsJoinInvitations();
                } else {
                    //alert("no data");
                    console.log("No data available");
                }
            }).catch((error) => {
                //alert(error)
                console.error(error);
            });

        }

        function isNumeric(str) {
            if (typeof str != "string") return false // we only process strings!  
            return !isNaN(str) && // use type coercion to parse the _entirety_ of the string (`parseFloat` alone does not do this)...
                !isNaN(parseFloat(str)) // ...and ensure strings of whitespace fail
        }

    </script>

    <footer id="gameFooter" class="bottom">
        <div style="margin-bottom: 8px; line-height: 15px;">
            Die Ravensburger AG ist in Deutschland im Besitz der eingetragenen Wortmarke "Memory". <br>
            Die Spielidee selbst geht zuzrück bis ins 12. Jahrhundert. <br />
        </div>
        <hr class="trenn-linie" style="margin-bottom: 5px;">
        </hr>
        <dev>
            Copyright 2022
            <a href="impressum.html" title="Impressum"> <img class="yin15" src="Bilder/yinyang.jpg"></a>
            IT-Abteilung der Berufsschule Freising. <br>
        </dev>
        <dev>
            <a href="index.html" title="Welcome">Welcome </a>
            |
            <a href="impressum.html" title="Impressum">Impressum</a>
        </dev>
    </footer>

</body>

</html>