<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <title>Bestliste</title>
    <link rel="stylesheet" type="text/css" href="CSS/formate.css" />
    <link rel="icon" type="image/x-icon"
        href="https://www.amadeus-hospitality.com/wp-content/uploads/2018/05/amadeus-icon-1.png">
    <script src="Skripte/Script1.js" type="text/javascript"></script>
</head>

<body>
    <header>
        <div><a id="links" href="game.html" title="Back to Memory"> <img class="yin" src="Bilder/yinyang.jpg"></a></div>
        <div><a id="rechts" class="link" href="https://www.bsz-fs.de/" title="Link zur Home-Page"> <img
                    src="Bilder/logo.png" width="250"></a></div>
        <div>
            <h1 id="mitte" class=center>Bestliste</h1>
        </div>
    </header>
    <h3 class="center" style="color: white;"> Bestliste seit 10.12.2022<br></h3>


    <div id="loaderboard-container">

        <div id="buttons-tables">
            <button id="leaderboardbtn">Bestliste</button>
            <button id="offlinebtn">Einzelspieler</button>
            <button id="onlinebtn">Mehrspieler</button>
        </div>

        <h2 id="modusLabel">Bestliste</h2>

        <table id="average-table" class="hide">
            <tr>
                <th>&Oslash; Züge</th>
                <th>&Oslash; Zeit</th>
                <th>G/V</th>
            </tr>

        </table>

        <table id="highlight-table" class="hide">

            <tr>
                <th colspan="8">Bestes Spiel</th>
            </tr>

        </table>

        <table id="leaderboard-table">
            <tr>
                <th>Platz</th>
                <th>Spieler</th>
                <th>Insgesamt</th>
                <th>Einzelspieler</th>
                <th>Mehrspieler</th>
                <th>&Oslash; Züge</th>
                <th>&Oslash; Zeit</th>
                <th>Karma</th>
            </tr>
            <tr>
                <td>1</td>
                <td>djey8</td>
                <td>45 / 60 = 75.25%</td>
                <td>30 / 33 = 90.23%</td>
                <td>15 / 27 = 50.30%</td>
                <td>15.66</td>
                <td>36:34</td>
                <td>1342</td>
            </tr>

        </table>

        <table id="online-table" class="hide">
            <tr>
                <th>ID</th>
                <th>Spieler</th>
                <th>Züge</th>
                <th>Beginn</th>
                <th>Ende</th>
                <th>Zeit</th>
                <th>Sieg</th>
                <th>Karma</th>
            </tr>

        </table>

        <table id="offline-table" class="hide">
            <tr>
                <th>ID</th>
                <th>Züge</th>
                <th>Beginn</th>
                <th>Ende</th>
                <th>Zeit</th>
                <th>Sieg</th>
                <th>Karma</th>
            </tr>
        </table>
        <h4 id="noUser" class="hide">Kein Benutzer angemeldet</h4>


    </div>

    <footer class="endBottom">
        <div style="margin-bottom: 8px; line-height: 15px;">
            Die Ravensburger AG ist in Deutschland im Besitz der eingetragenen Wortmarke "Memory". <br>
            Die Spielidee selbst geht zuzrück bis ins 12. Jahrhundert. <br />
        </div>
        <hr class="trenn-linie" style="margin-bottom: 5px;">
        </hr>
        <dev>
            Copyright 2022
            <a href="impressum.html" title="Impressum"> <img class="yin15" src="Bilder/yinyang.jpg"></a>
            IT-Abteilung der Berufsschule Freising. <br>
        </dev>
        <dev>
            <a href="index.html" title="Welcome">Welcome </a>
            |
            <a href="impressum.html" title="Impressum">Impressum</a>
        </dev>
    </footer>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-analytics.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getDatabase, ref, update, child, get } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyDgRC9CiBJRt2_gsHlRifB-MpE_xii7DXM",
            authDomain: "memory-app-b17ee.firebaseapp.com",
            projectId: "memory-app-b17ee",
            storageBucket: "memory-app-b17ee.appspot.com",
            messagingSenderId: "3637204477",
            appId: "1:3637204477:web:1493290d44957d81997594",
            measurementId: "G-XWPBGZWB4S",
            databaseURL: "https://memory-app-b17ee-default-rtdb.europe-west1.firebasedatabase.app"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const user = auth.currentUser;
        const database = getDatabase(app);
        const dbRef = ref(getDatabase(app));
        const leaderboardTable = document.getElementById("leaderboard-table");
        const onlineTable = document.getElementById("online-table");
        const offlineTable = document.getElementById("offline-table");
        const averageTable = document.getElementById("average-table");
        const highlightTable = document.getElementById("highlight-table");
        const noUser = document.getElementById("noUser");
        const modusLabel = document.getElementById("modusLabel");


        var offlineGames = [];
        var onlineGames = [];
        async function loadUserGames(user) {
            try {
                const [offlineSnapshot, onlineSnapshot] = await Promise.all([
                    get(child(dbRef, `users/${user.uid}/offline_games`)),
                    get(child(dbRef, `users/${user.uid}/online_games`))
                ]);

                offlineGames = offlineSnapshot.exists() ? offlineSnapshot.val() : [];
                onlineGames = onlineSnapshot.exists() ? onlineSnapshot.val() : [];
                noUser.classList.add("hide");
            } catch (error) {
                console.error(error);
                console.error('Failed to load games');

            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                loadUserGames(user);
            } else {
                noUser.classList.remove("hide");

            }
        });


        function toggleTableVisibility(leaderboard, online, offline, average, highlight, label) {
            leaderboardTable.classList.toggle("hide", leaderboard);
            onlineTable.classList.toggle("hide", online);
            offlineTable.classList.toggle("hide", offline);
            averageTable.classList.toggle("hide", average);
            highlightTable.classList.toggle("hide", highlight);
            modusLabel.innerText = label;
        }

        leaderboardbtn.addEventListener('click', (e) => {
            toggleTableVisibility(false, true, true, true, true, "Bestliste");
        });

        offlinebtn.addEventListener('click', (e) => {
            toggleTableVisibility(true, true, false, false, false, "Einzelspieler");
            loadOfflineAverage();
            loadOfflineHighlights();
            loadOfflineGames();
        });

        onlinebtn.addEventListener('click', (e) => {
            toggleTableVisibility(true, false, true, false, false, "Mehrspieler");
            loadOnlineHighlights();
            loadOnlineGames();
            loadOnlineAverage();
        });


        function loadOfflineHighlights(criteria) {
            highlightTable.innerHTML = "<tr><th id=\"bestGameLabel\" colspan=\"8\">Bestes Spiel</th></tr><tr><th>ID</th><th>Züge</th><th>Beginn</th><th>Ende</th><th>Zeit</th><th>Siege</th></tr>";
            let bestPoints;
            let winIndex;
            offlineGames.forEach((game, index) => {
                if (game.won) {
                    const startTime = new Date(game.start);
                    const endTime = new Date(game.end);
                    const gameDuration = (endTime - startTime) / 1000;
                    const tempPoints = game.moves + gameDuration;

                    if (typeof bestPoints === "undefined" || tempPoints < bestPoints) {
                        bestPoints = tempPoints;
                        winIndex = index;
                    }
                }
            });
            var wins = 0;
            for(let i = 0; i<offlineGames.length; i++){
                if(offlineGames[i].won){
                    wins += 1;
                }
            }

            if (typeof winIndex !== "undefined") {
                const bestGame = offlineGames[winIndex];
                const insertBestGame = `<tr><td>${winIndex + 1}</td><td>${bestGame.moves}</td><td>${bestGame.start}</td><td>${bestGame.end}</td><td>${bestGame.time}</td><td>${wins}</td></tr>`;
                highlightTable.innerHTML += insertBestGame;
            }
        }


        function loadOnlineHighlights(criteria) {
            highlightTable.innerHTML = "<tr><th id=\"bestGameLabel\" colspan=\"8\">Bestes Spiel</th></tr><tr><th>ID</th><th>Spieler</th><th>Treffer</th><th>Züge</th><th>Beginn</th><th>Ende</th><th>Zeit</th><th>Siege</th></tr>";
            if (onlineGames.length > 0) {
                let bestPoints;
                let winIndex;

                onlineGames.forEach((game, index) => {
                    if (game.won === 1) {
                        const startTime = new Date(game.start);
                        const endTime = new Date(game.end);
                        const gameDuration = (endTime - startTime) / 1000;
                        const tempPoints = game.moves + gameDuration;

                        if (typeof bestPoints === "undefined" || tempPoints < bestPoints) {
                            bestPoints = tempPoints;
                            winIndex = index;
                        }
                    }
                });

                var wins = 0;
                for(let i = 0; i<onlineGames.length; i++){
                    wins += onlineGames[i].won
                }

                if (typeof winIndex !== "undefined") {
                    const bestGame = onlineGames[winIndex];
                    const finalTime = bestGame.time === 0 ? "0:00" : `${Math.floor(bestGame.time / 60)}:${bestGame.time%60}`;
                    const insertBestGame = `<tr><td>${winIndex + 1}</td><td>${bestGame.opp}</td><td>${bestGame.hits}</td><td>${bestGame.moves}</td><td>${bestGame.start}</td><td>${bestGame.end}</td><td>${finalTime}</td><td>${wins}</td></tr>`;
                    highlightTable.innerHTML += insertBestGame;
                }
            }
        }


        function loadGames(table, games) {
            table.innerHTML = "<tr><th>ID</th><th>Züge</th><th>Beginn</th><th>Ende</th><th>Zeit</th><th>Sieg</th></tr>";
            for (let i = 0; i < games.length; i++) {
                const z = games.length - i - 1;
                const win = games[z].won ? "x" : "";
                const insertGame = `<tr><td>${z + 1}</td><td>${games[z].moves}</td><td>${games[z].start}</td><td>${games[z].end}</td><td>${games[z].time}</td><td>${win}</td></tr>`
                table.innerHTML += insertGame;
            }
        }

        function loadGames2(table, games) {
            table.innerHTML = "<tr><th>ID</th><th>Spieler</th><th>Treffer</th><th>Züge</th><th>Beginn</th><th>Ende</th><th>Zeit</th><th>Sieg</th></tr>";
            for (let i = 0; i < games.length; i++) {
                const z = games.length - i - 1;
                const finalTime = games[z].time === 0 ? "0:00" : `${Math.floor(games[z].time / 60)}:${games[z].time%60}`;
                const insertGame = `<tr><td>${z + 1}</td><td>${games[z].opp}</td><td>${games[z].hits}</td><td>${games[z].moves}</td><td>${games[z].start}</td><td>${games[z].end}</td><td>${finalTime}</td><td>${games[z].won}</td></tr>`
                table.innerHTML += insertGame;
            }
        }

        function loadOfflineGames() {
            loadGames(offlineTable, offlineGames);
        }

        function loadOnlineGames() {
            loadGames2(onlineTable, onlineGames);
        }

        function loadOfflineAverage() {
            averageTable.innerHTML = "<tr><th>&Oslash; Züge</th><th>&Oslash; Zeit</th><th>G/V</th></tr>";
            var sum = 0;
            for (let i = 0; i < offlineGames.length; i++){
                sum += parseInt(offlineGames[i].moves);
            }
            
            const averageMoves = sum/offlineGames.length;

            const totalWonGames = offlineGames.filter(game => game.won).length;
            const winRatio = (totalWonGames / offlineGames.length) * 100 || 0;

            const averageTime = offlineGames.length === 0 ? 0 : offlineGames
                .reduce((sum, game) => {
                    const [minutes, seconds] = game.time.split(":").map(time => parseInt(time));
                    return sum + minutes * 60 + seconds;
                }, 0) / offlineGames.length;

            const finalTime = averageTime === 0 ? "0:00.00" : `${Math.floor(averageTime / 60)}:${(averageTime%60).toFixed(2)}`;

            averageTable.innerHTML += `<tr><td>${averageMoves.toFixed(2)}</td><td>${finalTime}</td><td>${winRatio.toFixed(2)} %</td></tr>`;
        }


        function loadOnlineAverage() {
            averageTable.innerHTML = "<tr><th>&Oslash; Treffer</th><th>&Oslash; Züge</th><th>&Oslash; Zeit</th><th>G/V</th></tr>";
            if (!Array.isArray(onlineGames)) {
                console.error("onlineGames is not an array: ", onlineGames);
                return;
            }
            var sum1 = 0;
            var sum2 = 0;
            for (let i = 0; i < onlineGames.length; i++){
                sum1 += parseInt(onlineGames[i].moves);
                sum2 += parseInt(onlineGames[i].hits);
            }
            
            const averageMoves = sum1/onlineGames.length;
            const averageHits = sum2/onlineGames.length;
            const totalWonGames = onlineGames.filter(game => game.won === 1).length;
            const winRatio = (totalWonGames / onlineGames.length) * 100 || 0;

            const averageTime = onlineGames.length === 0 ? 0 : onlineGames
                .reduce((sum, game) => {
                    const time = game.time;
                    return sum + time;
                }, 0) / onlineGames.length;

            const finalTime = averageTime === 0 ? "0:00.00" : `${Math.floor(averageTime / 60)}:${(averageTime %60).toFixed(2)}`;

            averageTable.innerHTML += `<tr><td>${averageHits.toFixed(2)}</td><td>${averageMoves.toFixed(2)}</td><td>${finalTime}</td><td>${winRatio.toFixed(2)} %</td></tr>`;
        }

    </script>


</body>

</html>