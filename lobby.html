<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <title>Lobby</title>
    <link rel="stylesheet" type="text/css" href="CSS/formate.css" />
    <link rel="icon" type="image/x-icon"
        href="https://www.amadeus-hospitality.com/wp-content/uploads/2018/05/amadeus-icon-1.png">
    <script src="Skripte/Script1.js" type="text/javascript"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
</head>

<body>
    <header>
        <div>
            <a class="hide" id="l1" style="float: left;" title="Lobby löschen"> <img class="yin"
                    src="Bilder/yinyang.jpg"></a>
        </div>
        <div><a id="rechts" class="link" href="https://www.bsz-fs.de/" title="Link zur Home-Page"> <img
                    src="Bilder/logo.png" width="250"></a></div>
        <div>
            <h1 id="mitte" class=center>Lobby</h1>
        </div>
    </header>
    <h3 id="gameLabel" class="center" style="color: white;"></h3>
    <div id="player1Container">
        <h4 id="player1Label">Spieler 1</h4>
        <table id="player1-table" class="">
            <tr>
                <th>Spieler</th>
                <th>Status</th>
            </tr>
            <tr>
                <td id="name1Label">[Kein Spieler]</td>
                <td><img id="status1" src="Bilder/red.png" alt="Kein status"></td>
            </tr>
        </table>
        <button class="blue" id="ready1btn">bereit</button>
    </div>
    <div id="player2Container">
        <h4 id="player2Label">Spieler 2</h4>
        <table id="player2-table" class="">
            <tr>
                <th>Spieler</th>
                <th>Status</th>
            </tr>
            <tr>
                <td id="name2Label">[Kein Spieler]</td>
                <td><img id="status2" src="Bilder/red.png" alt="Kein status"></td>
            </tr>
        </table>
        <button class="blue" id="ready2btn">bereit</button>
    </div>
    <button id="verlassenbtn">Lobby verlassen</button>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-analytics.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getDatabase, ref, update, child, get, onValue } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyDgRC9CiBJRt2_gsHlRifB-MpE_xii7DXM",
            authDomain: "memory-app-b17ee.firebaseapp.com",
            projectId: "memory-app-b17ee",
            storageBucket: "memory-app-b17ee.appspot.com",
            messagingSenderId: "3637204477",
            appId: "1:3637204477:web:1493290d44957d81997594",
            measurementId: "G-XWPBGZWB4S",
            databaseURL: "https://memory-app-b17ee-default-rtdb.europe-west1.firebasedatabase.app"
        };



        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const user = auth.currentUser;
        const database = getDatabase(app);
        const dbRef = ref(getDatabase(app));
        const container = document.getElementById("login-container");
        const logoutC = document.getElementById("profile");
        const error = document.getElementById("errorMessage");



        var onlineGames = [];
        var all_invitations = [];
        var id = localStorage.getItem("gameID");

        var myName = "";
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in, see docs for a list of available properties
                // https://firebase.google.com/docs/reference/js/firebase.User
                const uid = user.uid;

                get(child(dbRef, `users/${user.uid}/username`)).then((snapshot) => {
                    if (snapshot.exists()) {
                        console.log(snapshot.val());
                        //alert(snapshot.val())
                        myName = snapshot.val();
                    } else {
                        console.log("No data available");
                    }
                }).catch((error) => {
                    //alert(error)
                    console.error(error);
                });


                if (!(id === "")) {
                    //hosted Game
                    onlineGames = [];
                    get(child(dbRef, `memory/list_hosted_games`)).then((snapshot) => {
                        if (snapshot.exists()) {
                            console.log(snapshot.val());
                            //alert(snapshot.val())
                            onlineGames = snapshot.val();
                            //noUser.classList.add("hide");
                            async function loadData(id, uid) {
                                try {
                                    const oppUsernameSnapshot = await get(child(dbRef, `memory/list_hosted_games/${id}/opp_username`));
                                    if (oppUsernameSnapshot.exists()) {
                                        document.getElementById("name2Label").innerText = oppUsernameSnapshot.val();
                                    } else {
                                        console.log("No oppUsername data available");
                                    }

                                    const usernameSnapshot = await get(child(dbRef, `users/${uid}/username`));
                                    if (usernameSnapshot.exists()) {
                                        myName = usernameSnapshot.val();
                                    } else {
                                        console.log("No username data available");
                                    }

                                    const ready2Snapshot = await get(child(dbRef, `memory/list_hosted_games/${id}/ready2`));
                                    if (ready2Snapshot.exists()) {
                                        var status2 = ready2Snapshot.val();
                                        if (status2) {
                                            document.getElementById("status1").src = "Bilder/green.png";
                                        }
                                    } else {
                                        console.log("No ready2 data available");
                                    }
                                } catch (error) {
                                    console.error(error);
                                }
                            }





                            //alert("games loaded");
                            const readyOne = document.getElementById("ready1btn");
                            const readyTwo = document.getElementById("ready2btn");
                            const trash = document.getElementById("l1");
                            trash.classList.add("hide");

                            document.getElementById("gameLabel").innerText = `"${onlineGames[id].gameName}"`;
                            document.getElementById("name1Label").innerText = `${onlineGames[id].username}`;

                            const ready1Ref = ref(database, `memory/list_hosted_games/${id}/ready1`);
                            const oppNameRef = ref(database, `memory/list_hosted_games/${id}/opp_username`);
                            const ready2Ref = ref(database, `memory/list_hosted_games/${id}/ready2`);

                            if (myName === onlineGames[id].username) {
                                readyOne.classList.remove("hide");
                                readyTwo.classList.add("hide");
                                onValue(ready2Ref, (snapshot) => {
                                    const data = snapshot.val();
                                    document.getElementById("status2").src = data ? "Bilder/green.png" : "Bilder/red.png";
                                    if(data && document.getElementById("status1").src.includes("Bilder/green.png")){
                                        alert("beide bereit; Spiel beginnt in 5 Sekunden :D");
                                    }
                                });
                                onValue(oppNameRef, (snapshot) => {
                                    document.getElementById("name2Label").innerText = snapshot.val();
                                });
                                trash.classList.remove("hide");
                                onlineGames[id].done = false;
                                update(ref(database, `memory`), {
                                    list_hosted_games: onlineGames
                                })
                                    .then(() => {
                                        console.log("game live again");
                                    })
                                    .catch((error) => {
                                        console.error("error with invite", error);
                                    });
                            } else {
                                readyOne.classList.add("hide");
                                readyTwo.classList.remove("hide");
                                document.getElementById("name2Label").innerText = myName;
                                onValue(ready1Ref, (snapshot) => {
                                    const data = snapshot.val();
                                    document.getElementById("status1").src = data ? "Bilder/green.png" : "Bilder/red.png";
                                    if(data && document.getElementById("status2").src.includes("Bilder/green.png")){
                                        alert("beide bereit; Spiel beginnt in 5 Sekunden :D");
                                    }
                                });
                            }

                        } else {
                            //alert("no data");
                            console.log("No data available");
                        }
                    }).catch((error) => {
                        //alert(error)
                        console.error(error);
                    });
                } else {
                    //Inivation Game
                    var inviteId = localStorage.getItem("invitationID");
                    var opp_uid = localStorage.getItem("opp_uid");
                    get(child(dbRef, `users/${opp_uid}/invitations`)).then((snapshot) => {
                        if (snapshot.exists()) {
                            console.log(snapshot.val());
                            //alert(snapshot.val())
                            all_invitations = snapshot.val();
                            //noUser.classList.add("hide");
                            //alert("games loaded");
                            const readyOne = document.getElementById("ready1btn");
                            const readyTwo = document.getElementById("ready2btn");
                            const trash = document.getElementById("l1");
                            readyOne.classList.remove("hide");
                            readyTwo.classList.add("hide");
                            document.getElementById("gameLabel").innerText = `"${all_invitations[inviteId].message}"`
                            document.getElementById("name1Label").innerText = `${all_invitations[inviteId].username}`
                            if (!(myName === all_invitations[inviteId].username)) {
                                const ready1 = ref(database, `users/${opp_uid}/invitations/${inviteId}/ready1`);
                                onValue(ready1, (snapshot) => {
                                    const data = snapshot.val();
                                    //alert("ready1 changed");
                                    //alert(data);
                                    if (data) {
                                        document.getElementById("status1").src = "Bilder/green.png";
                                    } else {
                                        document.getElementById("status1").src = "Bilder/red.png";
                                    }
                                });
                                readyOne.classList.add("hide");
                                readyTwo.classList.remove("hide");
                                document.getElementById("name2Label").innerText = myName;
                            } else {
                                const ready2 = ref(database, `users/${opp_uid}/invitations/${inviteId}/ready2`);
                                onValue(ready2, (snapshot) => {
                                    const data = snapshot.val();
                                    //alert("ready2 changed");
                                    //alert(data);
                                    if (data) {
                                        document.getElementById("status2").src = "Bilder/green.png";
                                    } else {
                                        document.getElementById("status2").src = "Bilder/red.png";
                                    }
                                });
                                const opp_name = ref(database, `users/${opp_uid}/invitations/${inviteId}/opp_username`);
                                onValue(opp_name, (snapshot) => {
                                    const data = snapshot.val();
                                    //alert("ready2 changed");
                                    //alert(data);
                                    document.getElementById("name2Label").innerText = data;
                                });
                                trash.classList.remove("hide");
                                all_invitations[inviteId].done = false;
                                var invitations = all_invitations;
                                update(ref(database, `users/${opp_uid}`), {
                                    invitations
                                })
                                    .then(() => {
                                        // Data saved successfully!
                                        console.log("game live again");
                                    })
                                    .catch((error) => {
                                        alert("error with invite");
                                    });
                            }

                        } else {
                            //alert("no data");
                            console.log("No data available");
                        }
                    }).catch((error) => {
                        //alert(error)
                        console.error(error);
                    });
                }
                // ...

            } else {
                // User is signed out
                // ...
                container.classList.remove("hide");
                logoutC.classList.add("hide");
            }
        });

        const readyOne = document.getElementById("ready1btn");
        const readyTwo = document.getElementById("ready2btn");
        ready1btn.addEventListener('click', (e) => {
            if (document.getElementById("status1").src.includes("Bilder/red.png")) {
                document.getElementById("status1").src = "Bilder/green.png";
                if(document.getElementById("status2").src.includes("Bilder/green.png")){
                    alert("beide bereit; Spiel beginnt in 5 Sekunden :D");
                }
                readyOne.innerText = "nicht bereit";
                readyOne.classList.remove("blue");
                readyOne.classList.add("red");
                var id = localStorage.getItem("gameID");
                if (!(id === "")) {
                    //hosted Game
                    onlineGames = [];
                    get(child(dbRef, `memory/list_hosted_games`)).then((snapshot) => {
                        if (snapshot.exists()) {
                            console.log(snapshot.val());
                            //alert(snapshot.val())
                            onlineGames = snapshot.val();
                            //noUser.classList.add("hide");
                            //alert("games loaded");
                            onlineGames[id].ready1 = true;
                            var list_hosted_games = onlineGames;
                            update(ref(database, `memory`), {
                                list_hosted_games
                            })
                                .then(() => {
                                    // Data saved successfully!
                                    console.log("player 1 ready");
                                })
                                .catch((error) => {
                                    alert("error with invite");
                                });
                        } else {
                            //alert("no data");
                            console.log("No data available");
                        }
                    }).catch((error) => {
                        //alert(error)
                        console.error(error);
                    });
                } else {
                    //Inivation Game
                    var inviteId = localStorage.getItem("invitationID");
                    var opp_uid = localStorage.getItem("opp_uid");
                    get(child(dbRef, `users/${opp_uid}/invitations`)).then((snapshot) => {
                        if (snapshot.exists()) {
                            console.log(snapshot.val());
                            //alert(snapshot.val())
                            all_invitations = snapshot.val();
                            //noUser.classList.add("hide");
                            //alert("games loaded");
                            all_invitations[inviteId].ready1 = true;
                            var invitations = all_invitations;
                            update(ref(database, `users/${opp_uid}`), {
                                invitations
                            })
                                .then(() => {
                                    // Data saved successfully!
                                    console.log("player 1 ready");
                                })
                                .catch((error) => {
                                    alert("error with invite");
                                });

                        } else {
                            //alert("no data");
                            console.log("No data available");
                        }
                    }).catch((error) => {
                        //alert(error)
                        console.error(error);
                    });
                }

            } else {
                document.getElementById("status1").src = "Bilder/red.png";
                readyOne.innerText = "bereit";
                readyOne.classList.add("blue");
                readyOne.classList.remove("red");
                var id = localStorage.getItem("gameID");
                if (!(id === "")) {
                    //hosted Game
                    onlineGames = [];
                    get(child(dbRef, `memory/list_hosted_games`)).then((snapshot) => {
                        if (snapshot.exists()) {
                            console.log(snapshot.val());
                            //alert(snapshot.val())
                            onlineGames = snapshot.val();
                            //noUser.classList.add("hide");
                            //alert("games loaded");
                            onlineGames[id].ready1 = false;
                            var list_hosted_games = onlineGames;
                            update(ref(database, `memory`), {
                                list_hosted_games
                            })
                                .then(() => {
                                    // Data saved successfully!
                                    console.log("player 1 not ready! Delet Lobby");
                                })
                                .catch((error) => {
                                    alert("error with invite");
                                });
                        } else {
                            //alert("no data");
                            console.log("No data available");
                        }
                    }).catch((error) => {
                        //alert(error)
                        console.error(error);
                    });
                } else {
                    //Inivation Game
                    var inviteId = localStorage.getItem("invitationID");
                    var opp_uid = localStorage.getItem("opp_uid");
                    get(child(dbRef, `users/${opp_uid}/invitations`)).then((snapshot) => {
                        if (snapshot.exists()) {
                            console.log(snapshot.val());
                            //alert(snapshot.val())
                            all_invitations = snapshot.val();
                            //noUser.classList.add("hide");
                            //alert("games loaded");
                            all_invitations[inviteId].ready1 = false;
                            var invitations = all_invitations;
                            update(ref(database, `users/${opp_uid}`), {
                                invitations
                            })
                                .then(() => {
                                    // Data saved successfully!
                                    console.log("player 1 not ready! Delet Lobby");
                                })
                                .catch((error) => {
                                    alert("error with invite");
                                });

                        } else {
                            //alert("no data");
                            console.log("No data available");
                        }
                    }).catch((error) => {
                        //alert(error)
                        console.error(error);
                    });
                }
            }
        });

        ready2btn.addEventListener('click', (e) => {
            if (document.getElementById("status2").src.includes("Bilder/red.png")) {
                document.getElementById("status2").src = "Bilder/green.png";
                if(readyOne.src.includes("Bilder/green.png")){
                    alert("beide bereit; Spiel beginnt in 5 Sekunden :D");
                }
                readyTwo.innerText = "nicht bereit";
                readyTwo.classList.remove("blue");
                readyTwo.classList.add("red");
                var id = localStorage.getItem("gameID");
                if (!(id === "")) {
                    //hosted Game
                    onlineGames = [];
                    get(child(dbRef, `memory/list_hosted_games`)).then((snapshot) => {
                        if (snapshot.exists()) {
                            console.log(snapshot.val());
                            //alert(snapshot.val())
                            onlineGames = snapshot.val();
                            //noUser.classList.add("hide");
                            //alert("games loaded");
                            onlineGames[id].ready2 = true;
                            var list_hosted_games = onlineGames;
                            update(ref(database, `memory`), {
                                list_hosted_games
                            })
                                .then(() => {
                                    // Data saved successfully!
                                    console.log("player 2 ready");
                                })
                                .catch((error) => {
                                    alert("error with invite");
                                });
                        } else {
                            //alert("no data");
                            console.log("No data available");
                        }
                    }).catch((error) => {
                        //alert(error)
                        console.error(error);
                    });
                } else {
                    //Inivation Game
                    var inviteId = localStorage.getItem("invitationID");
                    var opp_uid = localStorage.getItem("opp_uid");
                    get(child(dbRef, `users/${opp_uid}/invitations`)).then((snapshot) => {
                        if (snapshot.exists()) {
                            console.log(snapshot.val());
                            //alert(snapshot.val())
                            all_invitations = snapshot.val();
                            //noUser.classList.add("hide");
                            //alert("games loaded");
                            all_invitations[inviteId].ready2 = true;
                            var invitations = all_invitations;
                            update(ref(database, `users/${opp_uid}`), {
                                invitations
                            })
                                .then(() => {
                                    // Data saved successfully!
                                    console.log("player 2 ready");
                                })
                                .catch((error) => {
                                    alert("error with invite");
                                });

                        } else {
                            //alert("no data");
                            console.log("No data available");
                        }
                    }).catch((error) => {
                        //alert(error)
                        console.error(error);
                    });
                }
            } else {
                document.getElementById("status2").src = "Bilder/red.png";
                readyTwo.innerText = "bereit";
                readyTwo.classList.add("blue");
                readyTwo.classList.remove("red");
                var id = localStorage.getItem("gameID");
                if (!(id === "")) {
                    //hosted Game
                    onlineGames = [];
                    get(child(dbRef, `memory/list_hosted_games`)).then((snapshot) => {
                        if (snapshot.exists()) {
                            console.log(snapshot.val());
                            //alert(snapshot.val())
                            onlineGames = snapshot.val();
                            //noUser.classList.add("hide");
                            //alert("games loaded");
                            onlineGames[id].ready2 = false;
                            var list_hosted_games = onlineGames;
                            update(ref(database, `memory`), {
                                list_hosted_games
                            })
                                .then(() => {
                                    // Data saved successfully!
                                    console.log("player 2 not ready!");
                                })
                                .catch((error) => {
                                    alert("error with invite");
                                });
                        } else {
                            //alert("no data");
                            console.log("No data available");
                        }
                    }).catch((error) => {
                        //alert(error)
                        console.error(error);
                    });
                } else {
                    //Inivation Game
                    var inviteId = localStorage.getItem("invitationID");
                    var opp_uid = localStorage.getItem("opp_uid");
                    get(child(dbRef, `users/${opp_uid}/invitations`)).then((snapshot) => {
                        if (snapshot.exists()) {
                            console.log(snapshot.val());
                            //alert(snapshot.val())
                            all_invitations = snapshot.val();
                            //noUser.classList.add("hide");
                            //alert("games loaded");
                            all_invitations[inviteId].ready2 = false;
                            var invitations = all_invitations;
                            update(ref(database, `users/${opp_uid}`), {
                                invitations
                            })
                                .then(() => {
                                    // Data saved successfully!
                                    console.log("player 2 not ready!");
                                })
                                .catch((error) => {
                                    alert("error with invite");
                                });

                        } else {
                            //alert("no data");
                            console.log("No data available");
                        }
                    }).catch((error) => {
                        //alert(error)
                        console.error(error);
                    });
                }
            }
        });

        l1.addEventListener('click', (e) => {
            verlassen(true, "Wollen Sie die Lobby wirklich löschen", "error");
        });

        function verlassen(w, message, icon) {
            get(child(dbRef, `memory/list_hosted_games`)).then((snapshot) => {
                if (snapshot.exists()) {
                    console.log(snapshot.val());
                    //alert(snapshot.val())
                    onlineGames = snapshot.val();
                    //noUser.classList.add("hide");
                    //alert("games loaded");
                } else {
                    //alert("no data");
                    console.log("No data available");
                }
            }).catch((error) => {
                //alert(error)
                console.error(error);
            });
            swal({
                title: "Achtung!",
                text: `${message}?`,
                icon: icon,
                buttons: true,
                dangerMode: true,
            })
                .then((willDelete) => {
                    if (willDelete) {
                        var id = localStorage.getItem("gameID");
                        if (!(id === "")) {
                            onlineGames[id].done = w;
                            if (onlineGames[id].opp_username === myName) {
                                onlineGames[id].opp_username = "[kein Spieler]";
                                onlineGames[id].ready2 = false;
                            } else {
                                onlineGames[id].ready1 = false;
                            }
                            var list_hosted_games = onlineGames;
                            update(ref(database, `memory`), {
                                list_hosted_games
                            })
                                .then(() => {
                                    // Data saved successfully!
                                    console.log("game live again");
                                    window.location.href = "game.html"
                                })
                                .catch((error) => {
                                    alert("error with invite");
                                });
                        } else {
                            var inviteId = localStorage.getItem("invitationID");
                            var opp_uid = localStorage.getItem("opp_uid");
                            const auth = getAuth(app);
                            const user = auth.currentUser;
                            //window.location.href = "lobby.html";
                            all_invitations[inviteId].done = w;

                            if ((all_invitations[inviteId].opp_username === myName)) {
                                all_invitations[inviteId].opp_username = `[${all_invitations[inviteId].opp_username}] verlassen`;
                                all_invitations[inviteId].ready2 = false;
                            } else {
                                all_invitations[inviteId].ready1 = false;
                            }

                            var invitations = all_invitations;
                            update(ref(database, `users/${opp_uid}`), {
                                invitations
                            })
                                .then(() => {
                                    // Data saved successfully!
                                    console.log("game live again");
                                    window.location.href = "game.html";
                                })
                                .catch((error) => {
                                    alert("error with invite");
                                });
                        }

                    } else {
                        //swal("abgebrochen",{icon: "error"});
                    }
                });
        }


        verlassenbtn.addEventListener('click', (e) => {
            verlassen(false, "Wollen Sie die Lobby verlassen", "warning");
        });
    </script>
    <footer class="endBottom">
        <div style="margin-bottom: 8px; line-height: 15px;">
            Die Ravensburger AG ist in Deutschland im Besitz der eingetragenen Wortmarke "Memory". <br>
            Die Spielidee selbst geht zuzrück bis ins 12. Jahrhundert. <br />
        </div>
        <hr class="trenn-linie" style="margin-bottom: 5px;">
        </hr>
        <dev>
            Copyright 2022
            <a href="impressum.html" title="Impressum"> <img class="yin15" src="Bilder/yinyang.jpg"></a>
            IT-Abteilung der Berufsschule Freising. <br>
        </dev>
        <dev>
            <a href="index.html" title="Welcome">Welcome </a>
            |
            <a href="impressum.html" title="Impressum">Impressum</a>
        </dev>
    </footer>
</body>

</html>