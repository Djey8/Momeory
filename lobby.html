<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <title>Lobby</title>
    <link rel="stylesheet" type="text/css" href="CSS/formate.css" />
    <link rel="icon" type="image/x-icon"
        href="https://www.amadeus-hospitality.com/wp-content/uploads/2018/05/amadeus-icon-1.png">
    <script src="Skripte/Script1.js" type="text/javascript"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
</head>

<body>
    <header>
        <div>
            <a class="hide" id="l1" style="float: left;" title="Lobby löschen"> <img class="yin"
                    src="Bilder/yinyang.jpg"></a>
        </div>
        <div><a id="rechts" class="link" href="https://www.bsz-fs.de/" title="Link zur Home-Page"> <img
                    src="Bilder/logo.png" width="250"></a></div>
        <div>
            <h1 id="mitte" class=center>Lobby</h1>
        </div>
    </header>
    <h3 id="gameLabel" class="center" style="color: white;"></h3>
    <div id="player1Container">
        <h4 id="player1Label">Spieler 1</h4>
        <table id="player1-table" class="">
            <tr>
                <th>Spieler</th>
                <th>Status</th>
            </tr>
            <tr>
                <td id="name1Label">[Kein Spieler]</td>
                <td><img id="status1" src="Bilder/red.png" alt="Kein status"></td>
            </tr>
        </table>
        <button class="blue" id="ready1btn">bereit</button>
    </div>
    <div id="player2Container">
        <h4 id="player2Label">Spieler 2</h4>
        <table id="player2-table" class="">
            <tr>
                <th>Spieler</th>
                <th>Status</th>
            </tr>
            <tr>
                <td id="name2Label">[Kein Spieler]</td>
                <td><img id="status2" src="Bilder/red.png" alt="Kein status"></td>
            </tr>
        </table>
        <button class="blue" id="ready2btn">bereit</button>
    </div>
    <button id="verlassenbtn">Lobby verlassen</button>
    <p id="counter" class="hide"></p>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-analytics.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getDatabase, ref, update, child, get, onValue } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyDgRC9CiBJRt2_gsHlRifB-MpE_xii7DXM",
            authDomain: "memory-app-b17ee.firebaseapp.com",
            projectId: "memory-app-b17ee",
            storageBucket: "memory-app-b17ee.appspot.com",
            messagingSenderId: "3637204477",
            appId: "1:3637204477:web:1493290d44957d81997594",
            measurementId: "G-XWPBGZWB4S",
            databaseURL: "https://memory-app-b17ee-default-rtdb.europe-west1.firebasedatabase.app"
        };



        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const user = auth.currentUser;
        const database = getDatabase(app);
        const dbRef = ref(getDatabase(app));
        const container = document.getElementById("login-container");
        const logoutC = document.getElementById("profile");
        const error = document.getElementById("errorMessage");


        var allOnlineGames = [];
        var onlineGames = [];
        var hostedGames = [];
        var all_invitations = [];
        var id = localStorage.getItem("gameID");
        var all_user = [];

        async function loadUserGames(user) {
            try {
                const [allOnlineSnapshot, onlineSnapshot, allUserSnapshot] = await Promise.all([
                    get(child(dbRef, `memory/list_online_games`)),
                    get(child(dbRef, `users/${user.uid}/online_games`)),
                    get(child(dbRef, `list_all_users`))
                ]);

                allOnlineGames = allOnlineSnapshot.exists() ? allOnlineSnapshot.val() : [];
                onlineGames = onlineSnapshot.exists() ? onlineSnapshot.val() : [];
                all_user = allUserSnapshot.exists() ? allUserSnapshot.val() : [];
            } catch (error) {
                console.error(error);
                console.error('Failed to load games');

            }
        }

        var myName = "";
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loadUserGames(user);
                // User is signed in, see docs for a list of available properties
                // https://firebase.google.com/docs/reference/js/firebase.User
                const uid = user.uid;

                get(child(dbRef, `users/${user.uid}/username`)).then((snapshot) => {
                    if (snapshot.exists()) {
                        console.log(snapshot.val());
                        //alert(snapshot.val())
                        myName = snapshot.val();
                    } else {
                        console.log("No data available");
                    }
                }).catch((error) => {
                    //alert(error)
                    console.error(error);
                });


                if (!(id === "")) {
                    //hosted Game
                    hostedGames = [];
                    get(child(dbRef, `memory/list_hosted_games`)).then((snapshot) => {
                        if (snapshot.exists()) {
                            console.log(snapshot.val());
                            //alert(snapshot.val())
                            hostedGames = snapshot.val();
                            //noUser.classList.add("hide");
                            async function loadData(id, uid) {
                                try {
                                    const oppUsernameSnapshot = await get(child(dbRef, `memory/list_hosted_games/${id}/opp_username`));
                                    if (oppUsernameSnapshot.exists()) {
                                        document.getElementById("name2Label").innerText = oppUsernameSnapshot.val();
                                    } else {
                                        console.log("No oppUsername data available");
                                    }

                                    const usernameSnapshot = await get(child(dbRef, `users/${uid}/username`));
                                    if (usernameSnapshot.exists()) {
                                        myName = usernameSnapshot.val();
                                    } else {
                                        console.log("No username data available");
                                    }

                                    const ready2Snapshot = await get(child(dbRef, `memory/list_hosted_games/${id}/ready2`));
                                    if (ready2Snapshot.exists()) {
                                        var status2 = ready2Snapshot.val();
                                        if (status2) {
                                            document.getElementById("status1").src = "Bilder/green.png";
                                        }
                                    } else {
                                        console.log("No ready2 data available");
                                    }
                                } catch (error) {
                                    console.error(error);
                                }
                            }





                            //alert("games loaded");
                            const readyOne = document.getElementById("ready1btn");
                            const readyTwo = document.getElementById("ready2btn");
                            const trash = document.getElementById("l1");
                            trash.classList.add("hide");

                            document.getElementById("gameLabel").innerText = `"${hostedGames[id].gameName}"`;
                            document.getElementById("name1Label").innerText = `${hostedGames[id].username}`;

                            const ready1Ref = ref(database, `memory/list_hosted_games/${id}/ready1`);
                            const oppNameRef = ref(database, `memory/list_hosted_games/${id}/opp_username`);
                            const ready2Ref = ref(database, `memory/list_hosted_games/${id}/ready2`);

                            if (myName === hostedGames[id].username) {
                                readyOne.classList.remove("hide");
                                readyTwo.classList.add("hide");
                                onValue(ready2Ref, (snapshot) => {
                                    const data = snapshot.val();
                                    document.getElementById("status2").src = data ? "Bilder/green.png" : "Bilder/red.png";

                                    if (data && document.getElementById("status1").src.includes("Bilder/green.png")) {
                                        //Start Online Game
                                        //alert("beide bereit; Spiel beginnt in 5 Sekunden :D");
                                        startCountDown(false);
                                    }
                                });
                                onValue(oppNameRef, (snapshot) => {
                                    document.getElementById("name2Label").innerText = snapshot.val();
                                });
                                trash.classList.remove("hide");
                                hostedGames[id].done = false;
                                update(ref(database, `memory`), {
                                    list_hosted_games: hostedGames
                                })
                                    .then(() => {
                                        console.log("game live again");
                                    })
                                    .catch((error) => {
                                        console.error("error with invite", error);
                                    });
                            } else {
                                readyOne.classList.add("hide");
                                readyTwo.classList.remove("hide");
                                document.getElementById("name2Label").innerText = myName;
                                onValue(ready1Ref, (snapshot) => {
                                    const data = snapshot.val();
                                    document.getElementById("status1").src = data ? "Bilder/green.png" : "Bilder/red.png";

                                    if (data && document.getElementById("status2").src.includes("Bilder/green.png")) {
                                        //Start Online Game
                                        //alert("beide bereit; Spiel beginnt in 5 Sekunden :D");
                                        startCountDown(false);
                                    }
                                });
                            }

                        } else {
                            //alert("no data");
                            console.log("No data available");
                        }
                    }).catch((error) => {
                        //alert(error)
                        console.error(error);
                    });
                } else {
                    //Inivation Game
                    var inviteId = localStorage.getItem("invitationID");
                    var opp_uid = localStorage.getItem("opp_uid");
                    get(child(dbRef, `users/${opp_uid}/invitations`)).then((snapshot) => {
                        if (snapshot.exists()) {
                            console.log(snapshot.val());
                            //alert(snapshot.val())
                            all_invitations = snapshot.val();
                            //noUser.classList.add("hide");
                            //alert("games loaded");
                            const readyOne = document.getElementById("ready1btn");
                            const readyTwo = document.getElementById("ready2btn");
                            const trash = document.getElementById("l1");
                            readyOne.classList.remove("hide");
                            readyTwo.classList.add("hide");
                            document.getElementById("gameLabel").innerText = `"${all_invitations[inviteId].message}"`
                            document.getElementById("name1Label").innerText = `${all_invitations[inviteId].username}`
                            if (!(myName === all_invitations[inviteId].username)) {
                                const ready1 = ref(database, `users/${opp_uid}/invitations/${inviteId}/ready1`);
                                onValue(ready1, (snapshot) => {
                                    const data = snapshot.val();
                                    //alert("ready1 changed");
                                    //alert(data);
                                    if (data) {
                                        document.getElementById("status1").src = "Bilder/green.png";
                                    } else {
                                        document.getElementById("status1").src = "Bilder/red.png";
                                    }
                                });
                                readyOne.classList.add("hide");
                                readyTwo.classList.remove("hide");
                                document.getElementById("name2Label").innerText = myName;
                            } else {
                                const ready2 = ref(database, `users/${opp_uid}/invitations/${inviteId}/ready2`);
                                onValue(ready2, (snapshot) => {
                                    const data = snapshot.val();
                                    //alert("ready2 changed");
                                    //alert(data);
                                    if (data) {
                                        document.getElementById("status2").src = "Bilder/green.png";
                                    } else {
                                        document.getElementById("status2").src = "Bilder/red.png";
                                    }
                                });
                                const opp_name = ref(database, `users/${opp_uid}/invitations/${inviteId}/opp_username`);
                                onValue(opp_name, (snapshot) => {
                                    const data = snapshot.val();
                                    //alert("ready2 changed");
                                    //alert(data);
                                    document.getElementById("name2Label").innerText = data;
                                });
                                trash.classList.remove("hide");
                                all_invitations[inviteId].done = false;
                                var invitations = all_invitations;
                                update(ref(database, `users/${opp_uid}`), {
                                    invitations
                                })
                                    .then(() => {
                                        // Data saved successfully!
                                        console.log("game live again");
                                    })
                                    .catch((error) => {
                                        alert("error with invite");
                                    });
                            }

                        } else {
                            //alert("no data");
                            console.log("No data available");
                        }
                    }).catch((error) => {
                        //alert(error)
                        console.error(error);
                    });
                }
                // ...

            } else {
                // User is signed out
                // ...
                container.classList.remove("hide");
                logoutC.classList.add("hide");
            }
        });

        function startCountDown(neu) {
            document.getElementById("counter").classList.remove("hide");
            document.getElementById("counter").innerHTML = `5`
            const myInterval = setInterval(myTimer, 1000);
            var counter = 4
            function myTimer() {
                document.getElementById("counter").innerHTML = `${counter}`;
                counter -= 1;
                if (counter < 0) {
                    //Really start the game
                    myStopFunction();
                    //create new onlineGame Object and write to Database
                    var player1 = document.getElementById("name1Label").innerHTML;
                    var player2 = document.getElementById("name2Label").innerHTML;
                    if (neu) {
                        startOnlineGame(player1, player2);
                    } else {
                        loadOnlineGame()
                    }

                    //Go to onlineGame
                    //window.location.href = "onlineGame.html";
                }
            }

            function myStopFunction() {
                clearInterval(myInterval);
            }
        }

        function loadOnlineGame() {
            localStorage.setItem("gameID", "");
            window.location.href = "onlineGame.html";
        }
        //create online Object, start setting for a new Game
        function startOnlineGame(player1, player2) {
            console.log("startOnlineGame");
            const items = [
                { name: "pic1", image: "../Bilder/pic1-klein.jpeg" },
                { name: "pic2", image: "../Bilder/pic2-klein.jpeg" },
                { name: "pic3", image: "../Bilder/pic3-klein.jpeg" },
                { name: "pic4", image: "../Bilder/pic4-klein.jpeg" },
                { name: "pic5", image: "../Bilder/pic5-klein.jpeg" },
                { name: "pic6", image: "../Bilder/pic6-klein.jpeg" },
                { name: "pic7", image: "../Bilder/pic7-klein.jpeg" },
                { name: "pic8", image: "../Bilder/pic8-klein.jpeg" },
                { name: "pic9", image: "../Bilder/pic9-klein.jpeg" },
                { name: "pic10", image: "../Bilder/pic10-klein.jpeg" },
                { name: "pic11", image: "../Bilder/pic11-klein.jpeg" },
                { name: "pic12", image: "../Bilder/pic12-klein.jpeg" },
                { name: "pic13", image: "../Bilder/pic13-klein.jpg" },
                { name: "pic14", image: "../Bilder/pic14-klein.jpg" },
                { name: "pic15", image: "../Bilder/pic15-klein.jpg" },
                { name: "pic16", image: "../Bilder/pic16-klein.jpg" },
                { name: "pic17", image: "../Bilder/pic17-klein.jpg" },
                { name: "pic18", image: "../Bilder/pic18-klein.jpg" },
                { name: "pic19", image: "../Bilder/pic19-klein.jpg" },
                { name: "pic20", image: "../Bilder/pic20-klein.jpg" },
                { name: "pic21", image: "../Bilder/pic21-klein.jpg" },
                { name: "pic22", image: "../Bilder/pic22-klein.jpg" },
                { name: "pic23", image: "../Bilder/pic23-klein.jpg" },
                { name: "pic24", image: "../Bilder/pic24-klein.jpg" },
                { name: "pic25", image: "../Bilder/pic25-klein.jpg" },
                { name: "pic26", image: "../Bilder/pic26-klein.jpg" },
                { name: "pic27", image: "../Bilder/pic27-klein.jpg" },
                { name: "pic28", image: "../Bilder/pic28-klein.jpg" },
                { name: "pic29", image: "../Bilder/pic29-klein.jpg" },
                { name: "pic30", image: "../Bilder/pic30-klein.jpg" }
            ];

            var new_map = [];
            //create Map
            //get 8 numbers between 0 and 29
            for (let i = 0; i < 16; i++) {
                const rndInt = Math.floor(Math.random() * 30)
                //alert(rndInt)
                if (!new_map.includes(items[rndInt])) {
                    new_map.push(items[rndInt]);
                    new_map.push(items[rndInt]);
                    i++;
                }
            }
            var finish1 = false;
            while(!finish1){
                if(new_map.length === 16){
                    finish1 = true;
                    //alert("map finished"); 
                } else {
                    const rndInt = Math.floor(Math.random() * 30)
                    if (!new_map.includes(items[rndInt])) {
                        new_map.push(items[rndInt]);
                        new_map.push(items[rndInt]);
                        //alert("insertet extra pic");
                }
                }
            }
            //alert(new_map.length);

            function shuffle(array) {
                array.sort(() => Math.random() - 0.5);
            }
            shuffle(new_map);

            const auth = getAuth(app);
            const user = auth.currentUser;
            const date = new Date();
            var myEmail = `${user.email}`
            var myUsername = "";
            var uid1 = "";
            var uid2 = "";
            var oppUsername = "";
            get(child(dbRef, `memory/list_online_games`)).then((snapshot) => {
                if (snapshot.exists()) {
                    console.log(snapshot.val());
                    //alert(snapshot.val())
                    allOnlineGames = snapshot.val();
                    //alert("games loaded");
                } else {
                    allOnlineGames = [];
                }
            }).catch((error) => {
                //alert(error)
                console.error(error);
            });

            get(child(dbRef, `users/${user.uid}/username`)).then((snapshot) => {
                if (snapshot.exists()) {
                    console.log(snapshot.val());
                    //alert(snapshot.val())
                    myUsername = snapshot.val();
                    if (player1 === myUsername) {
                        uid1 = user.uid;
                        console.log("uid1");
                        for (let i = 0; i < all_user.length; i++) {
                            if (all_user[i].username === player2) {
                                uid2 = all_user[i].uid;
                                console.log("uid2");
                                break;
                            }
                        }
                    } else {
                        uid2 = user.uid;
                        console.log("uid2");
                        for (let i = 0; i < all_user.length; i++) {
                            if (all_user[i].username === player1) {
                                uid1 = all_user[i].uid;
                                console.log("uid1");
                                break;
                            }
                        }
                    }

                    let new_game = {
                        player1: {
                            uid: uid1,
                            username: player1,
                            moves: 0,
                            hits: 0,
                            time: 0
                        },
                        player2: {
                            uid: uid2,
                            username: player2,
                            moves: 0,
                            hits: 0,
                            time: 0
                        },
                        total_time: 0,
                        total_moves: 0,
                        total_hits: 0,
                        start: date.toUTCString(),
                        status: "Game startet",
                        ID: `${uid1}${uid2}${date.toUTCString()}`,
                        game_map: new_map
                    };

                    allOnlineGames.push(new_game);

                    let index = allOnlineGames.length - 1;
                    console.log(new_game);
                    update(ref(database, `memory`), {
                        list_online_games: allOnlineGames
                    })
                        .then(() => {
                            //create two online_games objects for each user
                            var onlineGames1 = [];
                            var onlineGames2 = [];
                            async function loadOnlineGames() {
                                try {
                                    const [online1Snapshot, online2Snapshot, onlineSnapshot] = await Promise.all([
                                        get(child(dbRef, `users/${uid1}/online_games`)),
                                        get(child(dbRef, `users/${uid2}/online_games`)),
                                        get(child(dbRef, `memory/list_hosted_games`)),
                                    ]);

                                    onlineGames1 = online1Snapshot.exists() ? online1Snapshot.val() : [];
                                    onlineGames2 = online2Snapshot.exists() ? online2Snapshot.val() : [];
                                    hostedGames = onlineSnapshot.exists() ? onlineSnapshot.val() : [];
                                } catch (error) {
                                    console.error(error);
                                    console.error('Failed to load games');

                                }
                            }
                            loadOnlineGames()
                                .then(() => {
                                    const new_onlineGame1 = {
                                        ID: `${uid1}${uid2}${date.toUTCString()}`,
                                        end: "not yet",
                                        start: date.toUTCString(),
                                        moves: 0,
                                        time: 0,
                                        opp: player2
                                    }
                                    const new_onlineGame2 = {
                                        ID: `${uid1}${uid2}${date.toUTCString()}`,
                                        end: "not yet",
                                        start: date.toUTCString(),
                                        moves: 0,
                                        time: 0,
                                        opp: player1
                                    }
                                    onlineGames1.push(new_onlineGame1);
                                    onlineGames2.push(new_onlineGame2);
                                    let online_games = onlineGames1;
                                    update(ref(database, `users/${uid1}`), { online_games })
                                        .then(() => {
                                            online_games = onlineGames2;
                                            update(ref(database, `users/${uid2}`), { online_games })
                                                .then(() => {
                                                    console.log(allOnlineGames[index].ID);
                                                    localStorage.setItem("gameID", allOnlineGames[index].ID);
                                                    if (!(id === "")) {
                                                        hostedGames[id].finished = true;
                                                        update(ref(database, `memory`), {
                                                            list_hosted_games: hostedGames
                                                        })
                                                            .then(() => {
                                                                console.log("game live again");
                                                            })
                                                            .catch((error) => {
                                                                console.error("error with invite", error);
                                                            });
                                                    } else {
                                                        var inviteId = localStorage.getItem("invitationID");
                                                        var opp_uid = localStorage.getItem("opp_uid");
                                                        all_invitations[inviteId].finished = true;
                                                        var invitations = all_invitations;
                                                        update(ref(database, `users/${opp_uid}`), {
                                                            invitations
                                                        })
                                                            .then(() => {
                                                                // Data saved successfully!
                                                                console.log("game live again");
                                                            })
                                                            .catch((error) => {
                                                                alert("error with invite");
                                                            });


                                                    }

                                                    window.location.href = "onlineGame.html";
                                                })
                                                .catch((error) => {
                                                    console.error("error with invite:", error);
                                                });
                                        })
                                        .catch((error) => {
                                            console.error("error with invite:", error);
                                        });
                                })
                                .catch((error) => {
                                    // The write failed...
                                    alert(error);
                                    //alert(error)
                                });

                        })
                        .catch((error) => {
                            // The write failed...
                            alert(error);
                            //alert(error)
                        });
                } else {
                    //alert("no data")
                    console.log("no user logged in");
                }
            }).catch((error) => {
                //alert(error)
                console.error(error);
            });
        }

        const readyOne = document.getElementById("ready1btn");
        const readyTwo = document.getElementById("ready2btn");
        ready1btn.addEventListener('click', (e) => {
            if (document.getElementById("status1").src.includes("Bilder/red.png")) {
                document.getElementById("status1").src = "Bilder/green.png";
                if (document.getElementById("status2").src.includes("Bilder/green.png")) {
                    //Start Online Game
                    //alert("beide bereit; Spiel beginnt in 5 Sekunden :D");
                    startCountDown(true);
                }
                readyOne.innerText = "nicht bereit";
                readyOne.classList.remove("blue");
                readyOne.classList.add("red");
                var id = localStorage.getItem("gameID");
                if (!(id === "")) {
                    //hosted Game
                    hostedGames = [];
                    get(child(dbRef, `memory/list_hosted_games`)).then((snapshot) => {
                        if (snapshot.exists()) {
                            console.log(snapshot.val());
                            //alert(snapshot.val())
                            hostedGames = snapshot.val();
                            //noUser.classList.add("hide");
                            //alert("games loaded");
                            hostedGames[id].ready1 = true;
                            var list_hosted_games = hostedGames;
                            update(ref(database, `memory`), {
                                list_hosted_games
                            })
                                .then(() => {
                                    // Data saved successfully!
                                    console.log("player 1 ready");
                                })
                                .catch((error) => {
                                    alert("error with invite");
                                });
                        } else {
                            //alert("no data");
                            console.log("No data available");
                        }
                    }).catch((error) => {
                        //alert(error)
                        console.error(error);
                    });
                } else {
                    //Inivation Game
                    var inviteId = localStorage.getItem("invitationID");
                    var opp_uid = localStorage.getItem("opp_uid");
                    get(child(dbRef, `users/${opp_uid}/invitations`)).then((snapshot) => {
                        if (snapshot.exists()) {
                            console.log(snapshot.val());
                            //alert(snapshot.val())
                            all_invitations = snapshot.val();
                            //noUser.classList.add("hide");
                            //alert("games loaded");
                            all_invitations[inviteId].ready1 = true;
                            var invitations = all_invitations;
                            update(ref(database, `users/${opp_uid}`), {
                                invitations
                            })
                                .then(() => {
                                    // Data saved successfully!
                                    console.log("player 1 ready");
                                })
                                .catch((error) => {
                                    alert("error with invite");
                                });

                        } else {
                            //alert("no data");
                            console.log("No data available");
                        }
                    }).catch((error) => {
                        //alert(error)
                        console.error(error);
                    });
                }

            } else {
                document.getElementById("status1").src = "Bilder/red.png";
                readyOne.innerText = "bereit";
                readyOne.classList.add("blue");
                readyOne.classList.remove("red");
                var id = localStorage.getItem("gameID");
                if (!(id === "")) {
                    //hosted Game
                    hostedGames = [];
                    get(child(dbRef, `memory/list_hosted_games`)).then((snapshot) => {
                        if (snapshot.exists()) {
                            console.log(snapshot.val());
                            //alert(snapshot.val())
                            hostedGames = snapshot.val();
                            //noUser.classList.add("hide");
                            //alert("games loaded");
                            hostedGames[id].ready1 = false;
                            var list_hosted_games = hostedGames;
                            update(ref(database, `memory`), {
                                list_hosted_games
                            })
                                .then(() => {
                                    // Data saved successfully!
                                    console.log("player 1 not ready! Delet Lobby");
                                })
                                .catch((error) => {
                                    alert("error with invite");
                                });
                        } else {
                            //alert("no data");
                            console.log("No data available");
                        }
                    }).catch((error) => {
                        //alert(error)
                        console.error(error);
                    });
                } else {
                    //Inivation Game
                    var inviteId = localStorage.getItem("invitationID");
                    var opp_uid = localStorage.getItem("opp_uid");
                    get(child(dbRef, `users/${opp_uid}/invitations`)).then((snapshot) => {
                        if (snapshot.exists()) {
                            console.log(snapshot.val());
                            //alert(snapshot.val())
                            all_invitations = snapshot.val();
                            //noUser.classList.add("hide");
                            //alert("games loaded");
                            all_invitations[inviteId].ready1 = false;
                            var invitations = all_invitations;
                            update(ref(database, `users/${opp_uid}`), {
                                invitations
                            })
                                .then(() => {
                                    // Data saved successfully!
                                    console.log("player 1 not ready! Delet Lobby");
                                })
                                .catch((error) => {
                                    alert("error with invite");
                                });

                        } else {
                            //alert("no data");
                            console.log("No data available");
                        }
                    }).catch((error) => {
                        //alert(error)
                        console.error(error);
                    });
                }
            }
        });

        ready2btn.addEventListener('click', (e) => {
            if (document.getElementById("status2").src.includes("Bilder/red.png")) {
                document.getElementById("status2").src = "Bilder/green.png";
                if (document.getElementById("status1").src.includes("Bilder/green.png")) {
                    //Start Online Game
                    //alert("beide bereit; Spiel beginnt in 5 Sekunden :D");
                    startCountDown(true);
                }
                readyTwo.innerText = "nicht bereit";
                readyTwo.classList.remove("blue");
                readyTwo.classList.add("red");
                var id = localStorage.getItem("gameID");

                if (!(id === "")) {

                    //hosted Game
                    hostedGames = [];
                    get(child(dbRef, `memory/list_hosted_games`)).then((snapshot) => {
                        if (snapshot.exists()) {
                            console.log(snapshot.val());
                            //alert(snapshot.val())
                            hostedGames = snapshot.val();
                            //noUser.classList.add("hide");
                            //alert("games loaded");
                            hostedGames[id].ready2 = true;
                            var list_hosted_games = hostedGames;
                            update(ref(database, `memory`), {
                                list_hosted_games
                            })
                                .then(() => {
                                    // Data saved successfully!
                                    console.log("player 2 ready");
                                })
                                .catch((error) => {
                                    alert("error with invite");
                                });
                        } else {
                            //alert("no data");
                            console.log("No data available");
                        }
                    }).catch((error) => {
                        //alert(error)
                        console.error(error);
                    });
                } else {
                    //Inivation Game
                    var inviteId = localStorage.getItem("invitationID");
                    var opp_uid = localStorage.getItem("opp_uid");
                    get(child(dbRef, `users/${opp_uid}/invitations`)).then((snapshot) => {
                        if (snapshot.exists()) {
                            console.log(snapshot.val());
                            //alert(snapshot.val())
                            all_invitations = snapshot.val();
                            //noUser.classList.add("hide");
                            //alert("games loaded");
                            all_invitations[inviteId].ready2 = true;
                            var invitations = all_invitations;
                            update(ref(database, `users/${opp_uid}`), {
                                invitations
                            })
                                .then(() => {
                                    // Data saved successfully!
                                    console.log("player 2 ready");
                                })
                                .catch((error) => {
                                    alert("error with invite");
                                });

                        } else {
                            //alert("no data");
                            console.log("No data available");
                        }
                    }).catch((error) => {
                        //alert(error)
                        console.error(error);
                    });
                }
            } else {
                document.getElementById("status2").src = "Bilder/red.png";
                readyTwo.innerText = "bereit";
                readyTwo.classList.add("blue");
                readyTwo.classList.remove("red");
                var id = localStorage.getItem("gameID");
                if (!(id === "")) {
                    //hosted Game
                    hostedGames = [];
                    get(child(dbRef, `memory/list_hosted_games`)).then((snapshot) => {
                        if (snapshot.exists()) {
                            console.log(snapshot.val());
                            //alert(snapshot.val())
                            hostedGames = snapshot.val();
                            //noUser.classList.add("hide");
                            //alert("games loaded");
                            hostedGames[id].ready2 = false;
                            var list_hosted_games = hostedGames;
                            update(ref(database, `memory`), {
                                list_hosted_games
                            })
                                .then(() => {
                                    // Data saved successfully!
                                    console.log("player 2 not ready!");
                                })
                                .catch((error) => {
                                    alert("error with invite");
                                });
                        } else {
                            //alert("no data");
                            console.log("No data available");
                        }
                    }).catch((error) => {
                        //alert(error)
                        console.error(error);
                    });
                } else {
                    //Inivation Game
                    var inviteId = localStorage.getItem("invitationID");
                    var opp_uid = localStorage.getItem("opp_uid");
                    get(child(dbRef, `users/${opp_uid}/invitations`)).then((snapshot) => {
                        if (snapshot.exists()) {
                            console.log(snapshot.val());
                            //alert(snapshot.val())
                            all_invitations = snapshot.val();
                            //noUser.classList.add("hide");
                            //alert("games loaded");
                            all_invitations[inviteId].ready2 = false;
                            var invitations = all_invitations;
                            update(ref(database, `users/${opp_uid}`), {
                                invitations
                            })
                                .then(() => {
                                    // Data saved successfully!
                                    console.log("player 2 not ready!");
                                })
                                .catch((error) => {
                                    alert("error with invite");
                                });

                        } else {
                            //alert("no data");
                            console.log("No data available");
                        }
                    }).catch((error) => {
                        //alert(error)
                        console.error(error);
                    });
                }
            }
        });

        l1.addEventListener('click', (e) => {
            verlassen(true, "Wollen Sie die Lobby wirklich löschen", "error");
        });

        function verlassen(w, message, icon) {
            get(child(dbRef, `memory/list_hosted_games`)).then((snapshot) => {
                if (snapshot.exists()) {
                    console.log(snapshot.val());
                    //alert(snapshot.val())
                    hostedGames = snapshot.val();
                    //noUser.classList.add("hide");
                    //alert("games loaded");
                } else {
                    //alert("no data");
                    console.log("No data available");
                }
            }).catch((error) => {
                //alert(error)
                console.error(error);
            });
            swal({
                title: "Achtung!",
                text: `${message}?`,
                icon: icon,
                buttons: true,
                dangerMode: true,
            })
                .then((willDelete) => {
                    if (willDelete) {
                        var id = localStorage.getItem("gameID");
                        if (!(id === "")) {
                            if (w) {
                                hostedGames[id].finished = true;
                                hostedGames[id].done = true;
                            }
                            if (hostedGames[id].opp_username === myName) {
                                hostedGames[id].opp_username = "[kein Spieler]";
                                hostedGames[id].ready2 = false;
                            } else {
                                hostedGames[id].ready1 = false;
                                hostedGames[id].done = true;
                            }
                            var list_hosted_games = hostedGames;
                            update(ref(database, `memory`), {
                                list_hosted_games
                            })
                                .then(() => {
                                    // Data saved successfully!
                                    console.log("game live again");
                                    window.location.href = "game.html"
                                })
                                .catch((error) => {
                                    alert("error with invite");
                                });
                        } else {
                            var inviteId = localStorage.getItem("invitationID");
                            var opp_uid = localStorage.getItem("opp_uid");
                            const auth = getAuth(app);
                            const user = auth.currentUser;
                            //window.location.href = "lobby.html";
                            if ((all_invitations[inviteId].opp_username === myName)) {
                                all_invitations[inviteId].opp_username = `[${all_invitations[inviteId].opp_username}] verlassen`;
                                all_invitations[inviteId].ready2 = false;
                            } else {
                                all_invitations[inviteId].ready1 = false;
                                all_invitations[inviteId].done = true;
                            }

                            var invitations = all_invitations;
                            update(ref(database, `users/${opp_uid}`), {
                                invitations
                            })
                                .then(() => {
                                    // Data saved successfully!
                                    console.log("game live again");
                                    window.location.href = "game.html";
                                })
                                .catch((error) => {
                                    alert("error with invite");
                                });
                        }

                    } else {
                        //swal("abgebrochen",{icon: "error"});
                    }
                });
        }


        verlassenbtn.addEventListener('click', (e) => {
            verlassen(false, "Wollen Sie die Lobby verlassen", "warning");
        });
    </script>
    <footer class="endBottom">
        <div style="margin-bottom: 8px; line-height: 15px;">
            Die Ravensburger AG ist in Deutschland im Besitz der eingetragenen Wortmarke "Memory". <br>
            Die Spielidee selbst geht zuzrück bis ins 12. Jahrhundert. <br />
        </div>
        <hr class="trenn-linie" style="margin-bottom: 5px;">
        </hr>
        <dev>
            Copyright 2022
            <a href="impressum.html" title="Impressum"> <img class="yin15" src="Bilder/yinyang.jpg"></a>
            IT-Abteilung der Berufsschule Freising. <br>
        </dev>
        <dev>
            <a href="index.html" title="Welcome">Welcome </a>
            |
            <a href="impressum.html" title="Impressum">Impressum</a>
        </dev>
    </footer>
</body>

</html>